(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))e(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(l){if(l.ep)return;l.ep=!0;const o=t(l);fetch(l.href,o)}})();/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const tt="https://docs.google.com/spreadsheets/d/e/2PACX-1vSekTVRYingSPdcpjSzVazPOJRJr_SxAyQV1lvqvgzvoW6BtnP8aEoVOo1sZSF6tJ27tLXv7JvxCPP9/pub?output=csv";function et(n){const a=n.trim().replace(/\r\n/g,`
`).split(`
`);if(a.length<2)return[];const t=o=>{const i=[];let s="",f=!1;for(let h=0;h<o.length;h++){const m=o[h];m==='"'?f&&o[h+1]==='"'?(s+='"',h++):f=!f:m===","&&!f?(i.push(s),s=""):s+=m}return i.push(s),i},e=t(a[1]).map(o=>o.trim()),l=[];for(let o=2;o<a.length;o++){const i=a[o];if(!i.trim())continue;const s=t(i),f={};let h=!1;e.forEach((m,r)=>{const c=s[r]||"";f[m]=c,c.trim()!==""&&(h=!0)}),h&&l.push(f)}return l}async function nt(){const n=`${tt}&_=${Date.now()}`;try{const a=await fetch(n);if(a.ok){const t=await a.text();return et(t)}console.warn(`Initial fetch with timestamp failed with status: ${a.status}. Retrying without timestamp.`)}catch(a){console.warn("Initial fetch with timestamp failed with a network error. Retrying without timestamp.",a)}console.log("Attempting fallback fetch without cache-busting timestamp.");try{const a=await fetch(tt);if(!a.ok)throw new Error(`Fallback fetch failed: ${a.status} ${a.statusText}`);const t=await a.text();return et(t)}catch(a){return console.error("Error fetching or parsing stall data after fallback:",a),[]}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const _=[{id:"A",num:1,coords:{top:87.8,left:91,width:1.05,height:1.4},border:{top:86.15,left:52.5,bottom:89.2,right:92.05}},{id:"B",num:1,coords:{top:83.1,left:91,width:1.05,height:1.4},border:{top:81.45,left:52.5,bottom:84.5,right:92.05}},{id:"C",num:1,coords:{top:78.4,left:91,width:1.05,height:1.4},border:{top:76.75,left:52.5,bottom:79.8,right:92.05}},{id:"D",num:1,coords:{top:73.5,left:91,width:1.05,height:1.4},border:{top:71.85,left:52.5,bottom:74.9,right:92.05}},{id:"E",num:1,coords:{top:68.5,left:91,width:1.05,height:1.4},border:{top:66.85,left:52.5,bottom:69.9,right:92.05}},{id:"F",num:1,coords:{top:63.9,left:91,width:1.05,height:1.4},border:{top:62.25,left:52.5,bottom:65.3,right:92.05}},{id:"G",num:1,coords:{top:59.1,left:91,width:1.05,height:1.4},border:{top:57.45,left:52.5,bottom:60.5,right:92.05}},{id:"H",num:1,coords:{top:54.3,left:91,width:1.05,height:1.4},border:{top:52.65,left:52.5,bottom:55.7,right:92.05}},{id:"I",num:1,coords:{top:49.5,left:91,width:1.05,height:1.4},border:{top:47.85,left:52.5,bottom:50.9,right:92.05}},{id:"J",num:1,coords:{top:44.5,left:91,width:1.05,height:1.4},border:{top:42.85,left:52.5,bottom:45.9,right:92.05}},{id:"K",num:1,coords:{top:39.6,left:91,width:1.05,height:1.4},border:{top:37.95,left:52.5,bottom:41,right:92.05}},{id:"L",num:1,coords:{top:34.8,left:91,width:1.05,height:1.4},border:{top:33.15,left:52.5,bottom:36.2,right:92.05}},{id:"M",num:1,coords:{top:30.1,left:91,width:1.05,height:1.4},border:{top:28.45,left:52.5,bottom:31.5,right:92.05}},{id:"N",num:1,coords:{top:25.2,left:91,width:1.05,height:1.4},border:{top:23.55,left:52.5,bottom:26.6,right:92.05}},{id:"O",num:1,coords:{top:20.4,left:91,width:1.05,height:1.4},border:{top:18.75,left:52.5,bottom:21.8,right:92.05}},{id:"P",num:1,coords:{top:15.6,left:91,width:1.05,height:1.4},border:{top:13.95,left:52.5,bottom:17,right:92.05}},{id:"Q",num:1,coords:{top:10.8,left:91,width:1.05,height:1.4},border:{top:9.15,left:52.5,bottom:12.2,right:92.05}},{id:"R",num:1,coords:{top:87.8,left:46.3,width:1.05,height:1.4},border:{top:86.15,left:7.8,bottom:89.2,right:47.35}},{id:"S",num:1,coords:{top:83.1,left:46.3,width:1.05,height:1.4},border:{top:81.45,left:7.8,bottom:84.5,right:47.35}},{id:"T",num:1,coords:{top:78.4,left:46.3,width:1.05,height:1.4},border:{top:76.75,left:7.8,bottom:79.8,right:47.35}},{id:"U",num:1,coords:{top:73.5,left:46.3,width:1.05,height:1.4},border:{top:71.85,left:7.8,bottom:74.9,right:47.35}},{id:"V",num:1,coords:{top:68.7,left:46.3,width:1.05,height:1.4},border:{top:67.05,left:7.8,bottom:70.1,right:47.35}},{id:"W",num:1,coords:{top:63.9,left:46.3,width:1.05,height:1.4},border:{top:62.25,left:7.8,bottom:65.3,right:47.35}},{id:"X",num:1,coords:{top:59.1,left:46.3,width:1.05,height:1.4},border:{top:57.45,left:7.8,bottom:60.5,right:47.35}},{id:"Y",num:1,coords:{top:54.3,left:46.3,width:1.05,height:1.4},border:{top:52.65,left:7.8,bottom:55.7,right:47.35}},{id:"Z",num:1,coords:{top:49.5,left:46.3,width:1.05,height:1.4},border:{top:47.85,left:7.8,bottom:50.9,right:47.35}},{id:"鼠",num:1,coords:{top:44.5,left:46.3,width:1.05,height:1.4},border:{top:42.85,left:7.8,bottom:45.9,right:47.35}},{id:"牛",num:1,coords:{top:39.6,left:46.3,width:1.05,height:1.4},border:{top:37.95,left:7.8,bottom:41,right:47.35}},{id:"虎",num:1,coords:{top:34.9,left:46.3,width:1.05,height:1.4},border:{top:33.25,left:7.8,bottom:36.3,right:47.35}},{id:"兔",num:1,coords:{top:30.1,left:46.3,width:1.05,height:1.4},border:{top:28.45,left:7.8,bottom:31.5,right:47.35}},{id:"龍",num:1,coords:{top:25.2,left:46.3,width:1.05,height:1.4},border:{top:23.55,left:7.8,bottom:26.6,right:47.35}},{id:"蛇",num:1,coords:{top:20.4,left:46.3,width:1.05,height:1.4},border:{top:18.75,left:7.8,bottom:21.8,right:47.35}},{id:"馬",num:1,coords:{top:15.6,left:46.3,width:1.05,height:1.4},border:{top:13.95,left:7.8,bottom:17,right:47.35}},{id:"羊",num:1,coords:{top:10.8,left:46.3,width:1.05,height:1.4},border:{top:9.15,left:7.8,bottom:12.2,right:47.35}},{id:"猴",num:1,coords:{top:73.5,left:4.5,width:1.1,height:1.44},border:{top:52.7,left:4.5,bottom:74.9,right:5.55},isGrouped:!0},{id:"雞",num:1,coords:{top:43.7,left:4.5,width:1.1,height:1.44},border:{top:23,left:4.5,bottom:45.6,right:5.55},isGrouped:!0},{id:"狗",num:1,coords:{top:18.2,left:4.5,width:1.1,height:1.44},border:{top:7.5,left:4.5,bottom:19.8,right:5.55},isGrouped:!0},{id:"特",num:1,coords:{top:84.4,left:4.15,width:1.8,height:2.41},border:{top:77.15,left:4.15,bottom:87.2,right:5.75},isGrouped:!0},{id:"商",num:1,coords:{top:89.5,left:4.15,width:1.8,height:2.41},border:{top:87.5,left:4.15,bottom:91.5,right:5.75},isGrouped:!0},{id:"範",num:1,coords:{top:.5,left:91,width:5,height:5},border:{top:.5,left:86,bottom:5.5,right:96}}];/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const it=new Map(_.map(n=>[n.id,n]));function at(n,a){return a?a.split(";").map((t,e)=>{const l=`${n}-宣傳車${e+1}`,o=t.trim();return{text:l,href:o}}).filter(t=>t!==null&&!!t.text&&!!t.href):[]}function st(n){const a=new Map;return n.forEach(t=>{const e=t.id||t.stallId;if(!e)return;let l=a.get(e);if(!l){const i=e.substring(0,1),s=parseInt(t.num,10),f=parseInt(t.stallCnt,10)||1,h=it.get(i);if(!h||isNaN(s)){console.warn(`Could not calculate position for stall ID: ${e}. Skipping base creation.`);return}const m=h.coords;let r;if(i!=="狗"&&i!=="雞"&&i!=="猴"&&i!=="特"&&i!=="商"){const c=s>36?72-s:s;let d=0,b=m.top,v=m.left;s>24&&s<=48?d=1.75:s<=12||s>=61?d=0:d=.9,s>36?(b=b-m.height-.25,v=m.left-c%72*m.width-d):(v=m.left-(c-1)*m.width-d,f>1&&(v-=(f-1)*m.width)),r={top:`${b}%`,left:`${v.toFixed(2)}%`,width:`${m.width*f}%`,height:`${m.height}%`}}else{let c=s,d=0;i==="狗"?s>=4&&s<16?(c=3,d=.8):s>=16&&(c=s-12,d=.4):i==="雞"?s>=4&&s<21?(c=3,d=.8):s>=21&&(c=s-17,d=.4):i==="猴"&&(s>=4&&s<23?(c=3,d=.8):s>=23&&(c=s-19,d=.5));let b=m.top-m.height*(c-1)-d;f>1&&(b-=(f-1)*m.height),r={top:`${b.toFixed(2)}%`,left:`${m.left}%`,width:`${m.width}%`,height:`${m.height*f}%`}}l={id:e,num:s,stallCnt:f,coords:r,stallTitle:t.stallTitle||"N/A",stallImg:t.stallImg||void 0,stallLink:t.stallLinks||void 0,promoData:[]},a.set(e,l)}const o=t.promoUser||"";if(o){const i={stallId:e,promoUser:o,promoAvatar:t.promoAvatar||"",promoHTML:t.promoHTML||"",promoLinks:at(o,t.promoLinks)};l.promoData.push(i)}}),Array.from(a.values())}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const R=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","鼠","牛","虎","兔","龍","蛇","馬","羊","商","特","猴","雞","狗"],lt=(n,a)=>{const t=a.toLowerCase().trim();return t===""?n:n.filter(e=>{const l=e.promoData.some(o=>o.promoUser.toLowerCase().includes(t));return e.id.toLowerCase().includes(t)||e.stallTitle.toLowerCase().includes(t)||l})},Y=(n,a,t)=>{const e=n.id.substring(0,1),l=n.num,o=["狗","雞","猴","特","商"].includes(e),i=R.indexOf(e);if(t==="right"&&e>="A"&&e<="Q"&&(l===1||l===72))return null;if(t==="left"||t==="right"){const s=t==="right"?"prev":"next",f=!o&&!(l>=1&&l<=36),h=s==="next"?1:-1,m=f?-h:h;let r=l+m;for(;r>=1&&r<=72;){const c=a.find(d=>d.id.startsWith(e)&&d.num===r);if(c)return c.id;r+=m}return null}if(t==="up"||t==="down"){if(i===-1)return null;const s=t==="up"?1:-1;let f=i+s;for(;f>=0&&f<R.length;){const h=R[f],m=a.filter(r=>r.id.startsWith(h));if(m.length>0){let r;return o?t==="down"?r=m.sort((c,d)=>d.num-c.num)[0]:r=m.sort((c,d)=>c.num-d.num)[0]:(r=m.find(c=>c.num===l),r||(r=m.sort((c,d)=>Math.abs(c.num-l)-Math.abs(d.num-l))[0])),(r==null?void 0:r.id)||null}f+=s}}return null};/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function rt(n,a,t,e,l,o,i,s,f){const h=f?3.5:2.5,m=new Map,r=new Map;let c=!1,d=!1,b=!1,v=0,E=0,y=0,B=0,k=!1,T=null;const U=()=>{const g=n.offsetWidth,p=n.offsetHeight;if(g===0||p===0)return;const w=(t.offsetLeft+t.offsetWidth/2)/g*100,x=(t.offsetTop+t.offsetHeight/2)/p*100;if(x<9.15||x>89.2){o.current.textContent="",o.prev.textContent="",o.next.textContent="";return}let D=null,X=1/0;for(const N of _){const G=Math.max(N.border.left-w,0,w-N.border.right),H=Math.max(N.border.top-x,0,x-N.border.bottom),F=G*G+H*H;F<X&&(X=F,D=N)}if(D){const N=R.indexOf(D.id);o.current.textContent=D.id,o.prev.textContent=N>0?R[N-1]:"",o.next.textContent=N<R.length-1?R[N+1]:""}else o.current.textContent="",o.prev.textContent="",o.next.textContent=""},u=()=>{const g=t.offsetWidth,p=t.offsetHeight,w=t.offsetLeft+g/2,x=t.offsetTop+p/2,$=-(w*h-g/2),A=-(x*h-p/2);e.style.backgroundPosition=`${$}px ${A}px`,l.style.left=`${$}px`,l.style.top=`${A}px`,U()},C=(g,p)=>{const w=t.offsetWidth,x=t.offsetHeight,$=n.offsetWidth,A=n.offsetHeight,D=-w/2,X=-x/2,N=$-w/2,G=A-x/2,H=Math.max(D,Math.min(g,N)),F=Math.max(X,Math.min(p,G));t.style.left=`${H}px`,t.style.top=`${F}px`;const J=o.current.parentElement;if(J){const Z=J.offsetWidth;let Q=0;H<0?Q=-H:H+Z>$&&(Q=$-(H+Z)),J.style.transform=`translateX(${Q}px) translateY(-50%)`}u()},M=g=>{var $;g.preventDefault(),c=!0,k=!1,T=g.target;const p=($=g.touches)==null?void 0:$[0],w=p?p.clientX:g.clientX,x=p?p.clientY:g.clientY;v=w,E=x,y=t.offsetLeft,B=t.offsetTop,document.addEventListener("mousemove",I),document.addEventListener("touchmove",I,{passive:!1}),document.addEventListener("mouseup",L),document.addEventListener("touchend",L)},I=g=>{var D;if(!c)return;const p=(D=g.touches)==null?void 0:D[0],w=p?p.clientX:g.clientX,x=p?p.clientY:g.clientY,$=w-v,A=x-E;!k&&(Math.abs($)>5||Math.abs(A)>5)&&(k=!0),C(y+$,B+A)},L=()=>{c&&(c=!1,document.removeEventListener("mousemove",I),document.removeEventListener("touchmove",I),document.removeEventListener("mouseup",L),document.removeEventListener("touchend",L),!k&&T&&T.closest(".stall-area")&&s(T),T=null)},S=()=>{if(d=!0,e.style.backgroundSize=`${a.offsetWidth*h}px ${a.offsetHeight*h}px`,e.style.backgroundImage=`url('${a.src}')`,l.style.width=`${a.offsetWidth}px`,l.style.height=`${a.offsetHeight}px`,l.style.transform=`scale(${h})`,t.style.display="block",!b){const g=n.offsetWidth,p=n.offsetHeight,w=t.offsetWidth,x=t.offsetHeight;C((g-w)/2,(p-x)/2),b=!0}i.setAttribute("aria-pressed","true"),i.textContent="隱藏放大鏡",u()},O=()=>{d=!1,t.style.display="none",i.setAttribute("aria-pressed","false"),i.textContent="顯示放大鏡"},P=()=>{d?O():S()};return i.addEventListener("click",P),t.addEventListener("mousedown",M),t.addEventListener("touchstart",M,{passive:!1}),{addStall:g=>{const p=g.dataset.stallId;if(!p)return;const w=g.cloneNode(!0);l.appendChild(w),m.set(p,g),r.set(p,w)},addGroupArea:g=>{const p=g.cloneNode(!0);l.appendChild(p)},updateStallClass:(g,p,w)=>{const x=m.get(g);x&&x.classList.toggle(p,w);const $=r.get(g);$&&$.classList.toggle(p,w)},show:S,hide:O,toggle:P,isShown:()=>d}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const dt=["map-container","map-image","magnifier-wrapper","magnifier","magnifier-stall-layer","tooltip","modal","modal-close","modal-overlay","modal-title","modal-body","modal-footer","instructions-text","search-input","toggle-magnifier-btn","modal-magnifier-wrapper","modal-magnifier","modal-magnifier-stall-layer","modal-nav-controls","modal-nav-up","modal-nav-down","modal-nav-left","modal-nav-right","magnifier-row-indicator-container","magnifier-row-indicator-prev","magnifier-row-indicator-current","magnifier-row-indicator-next","modal-magnifier-row-indicator-container","modal-magnifier-row-indicator-prev","modal-magnifier-row-indicator-current","modal-magnifier-row-indicator-next","modal-vertical-stall-list"];function ct(){const n={mapContainer:document.getElementById("map-container"),mapImage:document.getElementById("map-image"),magnifierWrapper:document.getElementById("magnifier-wrapper"),magnifier:document.getElementById("magnifier"),magnifierStallLayer:document.getElementById("magnifier-stall-layer"),magnifierRowIndicatorContainer:document.getElementById("magnifier-row-indicator-container"),magnifierRowIndicatorPrev:document.getElementById("magnifier-row-indicator-prev"),magnifierRowIndicatorCurrent:document.getElementById("magnifier-row-indicator-current"),magnifierRowIndicatorNext:document.getElementById("magnifier-row-indicator-next"),tooltip:document.getElementById("tooltip"),modal:document.getElementById("modal"),modalClose:document.getElementById("modal-close"),modalOverlay:document.getElementById("modal-overlay"),modalHeader:document.querySelector(".modal-header"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),modalFooter:document.getElementById("modal-footer"),instructionsEl:document.getElementById("instructions-text"),searchInput:document.getElementById("search-input"),toggleMagnifierBtn:document.getElementById("toggle-magnifier-btn"),modalMagnifierWrapper:document.getElementById("modal-magnifier-wrapper"),modalMagnifier:document.getElementById("modal-magnifier"),modalMagnifierStallLayer:document.getElementById("modal-magnifier-stall-layer"),modalMagnifierRowIndicatorContainer:document.getElementById("modal-magnifier-row-indicator-container"),modalMagnifierRowIndicatorPrev:document.getElementById("modal-magnifier-row-indicator-prev"),modalMagnifierRowIndicatorCurrent:document.getElementById("modal-magnifier-row-indicator-current"),modalMagnifierRowIndicatorNext:document.getElementById("modal-magnifier-row-indicator-next"),modalNavControls:document.getElementById("modal-nav-controls"),modalNavUp:document.getElementById("modal-nav-up"),modalNavDown:document.getElementById("modal-nav-down"),modalNavLeft:document.getElementById("modal-nav-left"),modalNavRight:document.getElementById("modal-nav-right"),modalVerticalStallList:document.getElementById("modal-vertical-stall-list")};for(const a in n)if(!n[a])throw new Error(`Essential DOM element not found: #${a}. The application cannot start.`);return n}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const W={selectedStallElement:null,stallIdToModalCloneMap:new Map,rowIdToModalGroupCloneMap:new Map};function mt(n,a,t,e){const l=new Set(_.filter(o=>o.isGrouped).map(o=>o.id));n.forEach(o=>{if(!o.coords)return;const i=document.createElement("div");i.className="stall-area",o.promoData.length>0&&i.classList.add("has-promo");const s=o.id.substring(0,1);l.has(s)&&i.classList.add("is-grouped-member"),i.dataset.stallId=o.id,i.style.top=o.coords.top,i.style.left=o.coords.left,i.style.width=o.coords.width,i.style.height=o.coords.height,i.setAttribute("aria-label",`Stall: ${o.stallTitle}`),o.num&&(i.textContent=o.num.toString().padStart(2,"0")),a.mapContainer.appendChild(i),t==null||t.addStall(i);const f=i.cloneNode(!0);a.modalMagnifierStallLayer.appendChild(f),e.stallIdToModalCloneMap.set(o.id,f)}),_.forEach(o=>{const i=document.createElement("div");if(i.className="stall-area stall-group-area",i.dataset.rowId=o.id,i.style.top=`${o.border.top}%`,i.style.left=`${o.border.left}%`,i.style.width=`${o.border.right-o.border.left}%`,i.style.height=`${o.border.bottom-o.border.top}%`,i.setAttribute("aria-label",`Row: ${o.id}`),i.textContent=o.id,o.isGrouped||i.classList.add("mobile-only-group"),a.mapContainer.appendChild(i),o.isGrouped){t==null||t.addGroupArea(i);const s=i.cloneNode(!0);a.modalMagnifierStallLayer.appendChild(s),e.rowIdToModalGroupCloneMap.set(o.id,s)}})}function K(n,a,t,e,l){const o=n.dataset.stallId;if(!o)return;e?e.updateStallClass(o,a,t):n.classList.toggle(a,t);const i=l.stallIdToModalCloneMap.get(o);i&&i.classList.toggle(a,t)}function ot(n,a,t){t.selectedStallElement&&K(t.selectedStallElement,"is-selected",!1,a,t),t.selectedStallElement=null,n.tooltip.classList.add("hidden")}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const q={wasMagnifierVisible:!1};function ft(n,a,t){const{modalMagnifierWrapper:e,modalMagnifier:l,modalMagnifierStallLayer:o,mapImage:i,modalMagnifierRowIndicatorContainer:s}=a,{modalMagnifierRowIndicatorPrev:f,modalMagnifierRowIndicatorCurrent:h,modalMagnifierRowIndicatorNext:m}=a;if(!n||!n.coords){e.style.display="none";return}e.style.display="block";const r=n.id.substring(0,1);if(r==="範")s.style.display="none";else{s.style.display="flex";const w=R.indexOf(r);h.textContent=r,f.textContent=w>0?R[w-1]:"",m.textContent=w<R.length-1?R[w+1]:""}const c=t?4.5:1.8,d=e.offsetWidth,b=e.offsetHeight;if(d===0||b===0){e.style.display="none";return}const v=i.offsetWidth,E=i.offsetHeight,y=v*c,B=E*c;o.style.width=`${v}px`,o.style.height=`${E}px`,o.style.transform=`scale(${c})`;const{left:k,top:T,width:U,height:u}=n.coords,[C,M,I,L]=[k,T,U,u].map(parseFloat);if([C,M,I,L].some(isNaN)){console.error("Could not parse stall coordinates for modal magnifier:",n.coords),e.style.display="none";return}const S=(C+I/2)/100*v,O=(M+L/2)/100*E,P=d/2-S*c,z=b/2-O*c;l.style.backgroundSize=`${y}px ${B}px`,l.style.backgroundImage=`url('${i.src}')`,l.style.backgroundPosition=`${P}px ${z}px`,o.style.left=`${P}px`,o.style.top=`${z}px`,o.querySelectorAll(".modal-map-hidden").forEach(w=>{w.classList.remove("modal-map-hidden")});const g=e.querySelector(".modal-stall-highlight");g&&g.remove();const p=document.createElement("div");p.className="modal-stall-highlight",p.style.width=`${I/100*v*c}px`,p.style.height=`${L/100*E*c}px`,e.appendChild(p)}function V(n,a){var k,T,U;const{allStalls:t,elements:e,magnifierController:l,uiState:o,isMobile:i}=a,s=t.find(u=>u.id===n);if(!s)return;l&&e.modal.classList.contains("hidden")&&(q.wasMagnifierVisible=l.isShown(),q.wasMagnifierVisible&&l.hide());const f=o.selectedStallElement,h=((k=f==null?void 0:f.dataset.stallId)==null?void 0:k.substring(0,1))??null;ot(e,l,o);const m=document.querySelector(`.stall-area[data-stall-id="${n}"]`);m&&(o.selectedStallElement=m,K(m,"is-selected",!0,l,o)),e.modalTitle.textContent=`${s.id}: ${s.stallTitle}`;let r=s.stallImg?`<img src="${s.stallImg}" alt="Official Promo Image: ${s.stallTitle}" class="official-stall-image" />`:"";s.stallImg&&s.promoData.length>0&&(r+='<hr class="promo-section-separator">'),s.promoData.forEach((u,C)=>{C>0&&(r+='<div class="promo-entry-separator"></div>');const M=u.promoAvatar?u.promoAvatar:"https://images.plurk.com/3rbw6tg1lA5dEGpdKTL8j1.png";r+=`
      <div class="promo-entry">
          <div class="modal-user-info">
              <img src="${M}" alt="${u.promoUser}" class="modal-avatar">
              <span class="modal-username">${u.promoUser}</span>
          </div>
          <div class="promo-html-content">${u.promoHTML}</div>
      </div>`}),e.modalBody.innerHTML=r||"暫無宣傳資訊。",e.modalFooter.innerHTML="";const c=u=>{if(u&&u.href){const C=document.createElement("a");C.href=u.href,C.textContent=u.text,C.className="footer-link",C.target="_blank",C.rel="noopener noreferrer",e.modalFooter.appendChild(C)}};s.promoData.forEach(u=>u.promoLinks.forEach(c)),s.stallLink&&c({href:s.stallLink,text:"社團網站"});const d=lt(t,e.searchInput.value),b=s.id.substring(0,1),E=["猴","雞","狗","特","商"].includes(b);if(E){e.modalNavLeft.style.display="none",e.modalNavRight.style.display="none",e.modalNavUp.style.display="block",e.modalNavDown.style.display="block",e.modalNavUp.ariaLabel="往上一個攤位",e.modalNavDown.ariaLabel="往下一個攤位";let u,C=1;for(;s.num+C<=34;){const L=(T=d.find(S=>S.id.startsWith(b)&&S.num===s.num+C))==null?void 0:T.id;if(L){u=L;break}C+=1}let M,I=-1;for(;s.num+I>0;){const L=(U=d.find(S=>S.id.startsWith(b)&&S.num===s.num+I))==null?void 0:U.id;if(L){M=L;break}I-=1}u||(u=Y(s,d,"up")),M||(M=Y(s,d,"down")),e.modalNavUp.disabled=!u,e.modalNavUp.dataset.targetId=u??"",e.modalNavDown.disabled=!M,e.modalNavDown.dataset.targetId=M??"",e.modalNavLeft.disabled=!0,e.modalNavRight.disabled=!0}else{e.modalNavLeft.style.display="block",e.modalNavRight.style.display="block",e.modalNavUp.style.display="block",e.modalNavDown.style.display="block",e.modalNavUp.ariaLabel="往上一排",e.modalNavDown.ariaLabel="往下一排";const u={up:Y(s,d,"up"),down:Y(s,d,"down"),left:Y(s,d,"left"),right:Y(s,d,"right")};e.modalNavUp.disabled=!u.up,e.modalNavUp.dataset.targetId=u.up??"",e.modalNavDown.disabled=!u.down,e.modalNavDown.dataset.targetId=u.down??"",e.modalNavLeft.disabled=!u.left,e.modalNavLeft.dataset.targetId=u.left??"",e.modalNavRight.disabled=!u.right,e.modalNavRight.dataset.targetId=u.right??""}const{modalVerticalStallList:y}=e,B=y.parentElement;if(E){b!==h&&(y.scrollTop=0),y.innerHTML="",y.style.display="flex",B&&(B.style.paddingLeft="");const u=t.filter(I=>I.id.startsWith(b)).sort((I,L)=>L.num-I.num),C=e.searchInput.value.toLowerCase().trim();u.forEach(I=>{const L=document.createElement("div");L.className="modal-vertical-stall-item",L.dataset.stallId=I.id,L.textContent=I.num.toString().padStart(2,"0"),I.promoData.length>0&&L.classList.add("has-promo");let S=!1;if(C!==""){const O=I.promoData.some(P=>P.promoUser.toLowerCase().includes(C));S=I.id.toLowerCase().includes(C)||I.stallTitle.toLowerCase().includes(C)||O}S&&L.classList.add("is-search-match"),I.id===n&&L.classList.add("is-selected"),y.appendChild(L)});const M=y.querySelector(".is-selected");M&&requestAnimationFrame(()=>{M.scrollIntoView({behavior:"smooth",block:"center"})})}else y.innerHTML="",y.style.display="none",B&&(B.style.paddingLeft="");document.body.classList.add("body-modal-open"),e.modal.classList.remove("hidden"),e.modalNavControls.style.display="grid",e.modal.setAttribute("aria-hidden","true"),ft(s,e,i)}function j(n){const{elements:a,magnifierController:t,uiState:e}=n;document.body.classList.remove("body-modal-open"),a.modal.classList.add("hidden"),a.modalNavControls.style.display="none",a.modal.setAttribute("aria-hidden","true"),ot(a,t,e),t&&q.wasMagnifierVisible&&t.show(),q.wasMagnifierVisible=!1,a.modalMagnifierWrapper.style.display="none",a.modalVerticalStallList.style.display="none"}function ht(n){const{elements:a,allStalls:t}=n;a.modalNavControls.addEventListener("click",o=>{const i=o.target.closest(".modal-nav-btn");i!=null&&i.dataset.targetId&&V(i.dataset.targetId,n)}),a.modalVerticalStallList.addEventListener("click",o=>{const i=o.target.closest(".modal-vertical-stall-item");i!=null&&i.dataset.stallId&&V(i.dataset.stallId,n)}),a.modalMagnifierWrapper.addEventListener("click",o=>{var m;const i=o.target,s=i.closest(".stall-group-area"),f=i.closest(".stall-area:not(.stall-group-area)"),h=(m=n.uiState.selectedStallElement)==null?void 0:m.dataset.stallId;if(s!=null&&s.dataset.rowId){const r=s.dataset.rowId;if(r===(h==null?void 0:h.substring(0,1)))return;const c=t.filter(d=>d.id.startsWith(r)).sort((d,b)=>b.num-d.num);c.length>0&&V(c[0].id,n)}else if(f!=null&&f.dataset.stallId){const r=f.dataset.stallId;if(r===h)return;V(r,n)}}),a.modalClose.addEventListener("click",()=>j(n)),a.modalOverlay.addEventListener("click",()=>j(n)),document.addEventListener("keydown",o=>{if(!a.modal.classList.contains("hidden"))switch(o.key){case"Escape":j(n);break;case"ArrowUp":a.modalNavUp.click();break;case"ArrowDown":a.modalNavDown.click();break;case"ArrowLeft":a.modalNavLeft.click();break;case"ArrowRight":a.modalNavRight.click();break}});const{modalNavControls:e,tooltip:l}=a;e.addEventListener("mouseover",o=>{const i=o.target.closest(".modal-nav-btn");if(i instanceof HTMLButtonElement&&!i.disabled){const s=i.ariaLabel;if(s){l.innerHTML=s;const f=i.getBoundingClientRect();l.classList.remove("hidden");const h=l.getBoundingClientRect(),m=f.top-h.height-8,r=f.left+f.width/2-h.width/2;l.style.left=`${r}px`,l.style.top=`${m}px`}}else l.classList.add("hidden")}),e.addEventListener("mouseleave",()=>{l.classList.add("hidden")})}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function ut(n){const a=()=>dt.every(e=>document.getElementById(e)),t=()=>{a()?n():requestAnimationFrame(t)};t()}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function pt(n){_.forEach(a=>{const t=document.createElement("div");t.className="debug-border",t.style.top=`${a.border.top}%`,t.style.left=`${a.border.left}%`,t.style.width=`${a.border.right-a.border.left}%`,t.style.height=`${a.border.bottom-a.border.top}%`;const e=document.createElement("span");e.textContent=a.id,t.appendChild(e),n.appendChild(t)})}async function gt(){const n=ct();new URLSearchParams(window.location.search).get("debug")==="true"&&n.mapContainer.classList.add("debug-mode"),n.instructionsEl.textContent="正在載入地圖與攤位資料",n.instructionsEl.classList.add("loading-text");const t=new Promise((e,l)=>{n.mapImage.complete?e():(n.mapImage.onload=()=>e(),n.mapImage.onerror=()=>l(new Error("Map image failed to load.")))});try{const[e]=await Promise.all([nt(),t]);if(n.instructionsEl.classList.remove("loading-text"),e.length===0){n.mapContainer.innerHTML='<p style="color: red; padding: 20px;"><b>無法載入攤位資料：</b><br>請檢查您的 Google Sheet 是否已「發佈至網路」、網址是否正確，或檢查您的網路連線。</p>',n.instructionsEl.textContent="載入失敗";return}const l=st(e),i=window.matchMedia("(max-width: 768px)").matches,s={allStalls:l,elements:n,magnifierController:null,uiState:W,isMobile:i},f=r=>{const c=r.closest(".stall-group-area"),d=r.closest(".stall-area:not(.stall-group-area)");if(c!=null&&c.dataset.rowId){const b=c.dataset.rowId,v=l.filter(E=>E.id.startsWith(b)).sort((E,y)=>y.num-E.num);v.length>0&&V(v[0].id,s)}else d!=null&&d.dataset.stallId&&V(d.dataset.stallId,s)},h=rt(n.mapContainer,n.mapImage,n.magnifierWrapper,n.magnifier,n.magnifierStallLayer,{prev:n.magnifierRowIndicatorPrev,current:n.magnifierRowIndicatorCurrent,next:n.magnifierRowIndicatorNext},n.toggleMagnifierBtn,f,i);s.magnifierController=h,mt(l,n,h,W),pt(n.mapContainer),ht(s),n.searchInput.addEventListener("input",()=>{const r=n.searchInput.value.toLowerCase().trim(),c=new Set;l.forEach(d=>{const b=document.querySelector(`.stall-area[data-stall-id="${d.id}"]`);if(!b)return;let v=!1;if(r!==""){const E=d.promoData.some(y=>y.promoUser.toLowerCase().includes(r));v=d.id.toLowerCase().includes(r)||d.stallTitle.toLowerCase().includes(r)||E}K(b,"is-search-match",v,h,W),v&&c.add(d.id.substring(0,1))}),_.forEach(d=>{document.querySelectorAll(`.stall-group-area[data-row-id="${d.id}"]`).forEach(v=>{const E=c.has(d.id);v.classList.toggle("is-search-match",E)})})});const m=r=>{const c=r.target;c.closest("#magnifier-wrapper")||(r.type==="touchstart"&&r.preventDefault(),f(c))};i?(n.instructionsEl.textContent="點擊按鈕可用放大鏡，或直接點擊攤位查看宣傳。",n.mapContainer.addEventListener("mousedown",m,{passive:!1}),n.mapContainer.addEventListener("touchstart",m,{passive:!1})):(n.instructionsEl.textContent="點擊按鈕顯示/隱藏放大鏡並拖曳。點擊攤位(含放大鏡內)可看宣傳。",document.addEventListener("mousemove",r=>{W.selectedStallElement||(n.tooltip.style.left=`${r.clientX+15}px`,n.tooltip.style.top=`${r.clientY+15}px`)}),n.mapContainer.addEventListener("mouseover",r=>{var b;const d=r.target.closest(".stall-area:not(.stall-group-area)");if(d&&!W.selectedStallElement){const v=d.dataset.stallId,E=l.find(y=>y.id===v);if(E){const y=(b=E.promoData)==null?void 0:b[0];n.tooltip.innerHTML=`<strong>${E.stallTitle}</strong><br><small>${E.id}${y!=null&&y.promoUser?` / ${y.promoUser}`:""}</small>`,n.tooltip.classList.remove("hidden")}}}),n.mapContainer.addEventListener("mouseout",r=>{r.target.classList.contains("stall-area")&&n.tooltip.classList.add("hidden")}),n.mapContainer.addEventListener("mousedown",m))}catch(e){console.error("Failed to initialize app:",e),n.instructionsEl.classList.remove("loading-text"),n.instructionsEl.textContent="地圖或資料載入失敗，請重新整理頁面。"}}ut(gt);
