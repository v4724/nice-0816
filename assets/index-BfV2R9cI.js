(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))n(d);new MutationObserver(d=>{for(const i of d)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function e(d){const i={};return d.integrity&&(i.integrity=d.integrity),d.referrerPolicy&&(i.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?i.credentials="include":d.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(d){if(d.ep)return;d.ep=!0;const i=e(d);fetch(d.href,i)}})();/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const tt="https://docs.google.com/spreadsheets/d/e/2PACX-1vSekTVRYingSPdcpjSzVazPOJRJr_SxAyQV1lvqvgzvoW6BtnP8aEoVOo1sZSF6tJ27tLXv7JvxCPP9/pub?output=csv";function et(t){const o=t.trim().replace(/\r\n/g,`
`).split(`
`);if(o.length<2)return[];const e=i=>{const l=[];let s="",h=!1;for(let g=0;g<i.length;g++){const m=i[g];m==='"'?h&&i[g+1]==='"'?(s+='"',g++):h=!h:m===","&&!h?(l.push(s),s=""):s+=m}return l.push(s),l},n=e(o[1]).map(i=>i.trim()),d=[];for(let i=2;i<o.length;i++){const l=o[i];if(!l.trim())continue;const s=e(l),h={};let g=!1;n.forEach((m,c)=>{const r=s[c]||"";h[m]=r,r.trim()!==""&&(g=!0)}),g&&d.push(h)}return d}async function it(){const t=`${tt}&_=${Date.now()}`;try{const o=await fetch(t);if(o.ok){const e=await o.text();return et(e)}console.warn(`Initial fetch with timestamp failed with status: ${o.status}. Retrying without timestamp.`)}catch(o){console.warn("Initial fetch with timestamp failed with a network error. Retrying without timestamp.",o)}console.log("Attempting fallback fetch without cache-busting timestamp.");try{const o=await fetch(tt);if(!o.ok)throw new Error(`Fallback fetch failed: ${o.status} ${o.statusText}`);const e=await o.text();return et(e)}catch(o){return console.error("Error fetching or parsing stall data after fallback:",o),[]}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const P=[{id:"A",num:1,coords:{top:87.8,left:91,width:1.05,height:1.4},border:{top:86.15,left:52.5,bottom:89.2,right:92.05}},{id:"B",num:1,coords:{top:83.1,left:91,width:1.05,height:1.4},border:{top:81.45,left:52.5,bottom:84.5,right:92.05}},{id:"C",num:1,coords:{top:78.4,left:91,width:1.05,height:1.4},border:{top:76.75,left:52.5,bottom:79.8,right:92.05}},{id:"D",num:1,coords:{top:73.5,left:91,width:1.05,height:1.4},border:{top:71.85,left:52.5,bottom:74.9,right:92.05}},{id:"E",num:1,coords:{top:68.5,left:91,width:1.05,height:1.4},border:{top:66.85,left:52.5,bottom:69.9,right:92.05}},{id:"F",num:1,coords:{top:63.9,left:91,width:1.05,height:1.4},border:{top:62.25,left:52.5,bottom:65.3,right:92.05}},{id:"G",num:1,coords:{top:59.1,left:91,width:1.05,height:1.4},border:{top:57.45,left:52.5,bottom:60.5,right:92.05}},{id:"H",num:1,coords:{top:54.3,left:91,width:1.05,height:1.4},border:{top:52.65,left:52.5,bottom:55.7,right:92.05}},{id:"I",num:1,coords:{top:49.5,left:91,width:1.05,height:1.4},border:{top:47.85,left:52.5,bottom:50.9,right:92.05}},{id:"J",num:1,coords:{top:44.5,left:91,width:1.05,height:1.4},border:{top:42.85,left:52.5,bottom:45.9,right:92.05}},{id:"K",num:1,coords:{top:39.6,left:91,width:1.05,height:1.4},border:{top:37.95,left:52.5,bottom:41,right:92.05}},{id:"L",num:1,coords:{top:34.8,left:91,width:1.05,height:1.4},border:{top:33.15,left:52.5,bottom:36.2,right:92.05}},{id:"M",num:1,coords:{top:30.1,left:91,width:1.05,height:1.4},border:{top:28.45,left:52.5,bottom:31.5,right:92.05}},{id:"N",num:1,coords:{top:25.2,left:91,width:1.05,height:1.4},border:{top:23.55,left:52.5,bottom:26.6,right:92.05}},{id:"O",num:1,coords:{top:20.4,left:91,width:1.05,height:1.4},border:{top:18.75,left:52.5,bottom:21.8,right:92.05}},{id:"P",num:1,coords:{top:15.6,left:91,width:1.05,height:1.4},border:{top:13.95,left:52.5,bottom:17,right:92.05}},{id:"Q",num:1,coords:{top:10.8,left:91,width:1.05,height:1.4},border:{top:9.15,left:52.5,bottom:12.2,right:92.05}},{id:"R",num:1,coords:{top:87.8,left:46.3,width:1.05,height:1.4},border:{top:86.15,left:7.8,bottom:89.2,right:47.35}},{id:"S",num:1,coords:{top:83.1,left:46.3,width:1.05,height:1.4},border:{top:81.45,left:7.8,bottom:84.5,right:47.35}},{id:"T",num:1,coords:{top:78.4,left:46.3,width:1.05,height:1.4},border:{top:76.75,left:7.8,bottom:79.8,right:47.35}},{id:"U",num:1,coords:{top:73.5,left:46.3,width:1.05,height:1.4},border:{top:71.85,left:7.8,bottom:74.9,right:47.35}},{id:"V",num:1,coords:{top:68.7,left:46.3,width:1.05,height:1.4},border:{top:67.05,left:7.8,bottom:70.1,right:47.35}},{id:"W",num:1,coords:{top:63.9,left:46.3,width:1.05,height:1.4},border:{top:62.25,left:7.8,bottom:65.3,right:47.35}},{id:"X",num:1,coords:{top:59.1,left:46.3,width:1.05,height:1.4},border:{top:57.45,left:7.8,bottom:60.5,right:47.35}},{id:"Y",num:1,coords:{top:54.3,left:46.3,width:1.05,height:1.4},border:{top:52.65,left:7.8,bottom:55.7,right:47.35}},{id:"Z",num:1,coords:{top:49.5,left:46.3,width:1.05,height:1.4},border:{top:47.85,left:7.8,bottom:50.9,right:47.35}},{id:"鼠",num:1,coords:{top:44.5,left:46.3,width:1.05,height:1.4},border:{top:42.85,left:7.8,bottom:45.9,right:47.35}},{id:"牛",num:1,coords:{top:39.6,left:46.3,width:1.05,height:1.4},border:{top:37.95,left:7.8,bottom:41,right:47.35}},{id:"虎",num:1,coords:{top:34.9,left:46.3,width:1.05,height:1.4},border:{top:33.25,left:7.8,bottom:36.3,right:47.35}},{id:"兔",num:1,coords:{top:30.1,left:46.3,width:1.05,height:1.4},border:{top:28.45,left:7.8,bottom:31.5,right:47.35}},{id:"龍",num:1,coords:{top:25.2,left:46.3,width:1.05,height:1.4},border:{top:23.55,left:7.8,bottom:26.6,right:47.35}},{id:"蛇",num:1,coords:{top:20.4,left:46.3,width:1.05,height:1.4},border:{top:18.75,left:7.8,bottom:21.8,right:47.35}},{id:"馬",num:1,coords:{top:15.6,left:46.3,width:1.05,height:1.4},border:{top:13.95,left:7.8,bottom:17,right:47.35}},{id:"羊",num:1,coords:{top:10.8,left:46.3,width:1.05,height:1.4},border:{top:9.15,left:7.8,bottom:12.2,right:47.35}},{id:"猴",num:1,coords:{top:73.5,left:4.5,width:1.1,height:1.44},border:{top:52.7,left:4.5,bottom:74.9,right:5.55},isGrouped:!0},{id:"雞",num:1,coords:{top:43.7,left:4.5,width:1.1,height:1.44},border:{top:23,left:4.5,bottom:45.6,right:5.55},isGrouped:!0},{id:"狗",num:1,coords:{top:18.2,left:4.5,width:1.1,height:1.44},border:{top:7.5,left:4.5,bottom:19.8,right:5.55},isGrouped:!0},{id:"特",num:1,coords:{top:84.4,left:4.15,width:1.8,height:2.41},border:{top:77.15,left:4.15,bottom:87.2,right:5.75},isGrouped:!0},{id:"商",num:1,coords:{top:89.5,left:4.15,width:1.8,height:2.41},border:{top:87.5,left:4.15,bottom:91.5,right:5.75},isGrouped:!0},{id:"範",num:1,coords:{top:.5,left:91,width:5,height:5},border:{top:.5,left:86,bottom:5.5,right:96}}];/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const at=new Map(P.map(t=>[t.id,t]));function st(t,o){return o?o.split(";").map((e,n)=>{const d=`${t}-宣傳車${n+1}`,i=e.trim();return{text:d,href:i}}).filter(e=>e!==null&&!!e.text&&!!e.href):[]}function lt(t){const o=new Map;return t.forEach(e=>{const n=e.id||e.stallId;if(!n)return;let d=o.get(n);if(!d){const l=n.substring(0,1),s=parseInt(e.num,10),h=parseInt(e.stallCnt,10)||1,g=at.get(l);if(!g||isNaN(s)){console.warn(`Could not calculate position for stall ID: ${n}. Skipping base creation.`);return}const m=g.coords;let c,r;if(l!=="狗"&&l!=="雞"&&l!=="猴"&&l!=="特"&&l!=="商"){const a=s>36?72-s:s;let f=0,b=m.top,u=m.left;s>24&&s<=48?f=1.75:s<=12||s>=61?f=0:f=.9,s>36?(b=b-m.height-.25,u=m.left-a%72*m.width-f):(u=m.left-(a-1)*m.width-f,h>1&&(u-=(h-1)*m.width));const w=parseFloat(u.toFixed(2)),M=m.width*h;c={top:`${b}%`,left:`${w}%`,width:`${M}%`,height:`${m.height}%`},r={top:b,left:w,width:M,height:m.height}}else{let a=s,f=0;l==="狗"?s>=4&&s<16?(a=3,f=.8):s>=16&&(a=s-12,f=.4):l==="雞"?s>=4&&s<21?(a=3,f=.8):s>=21&&(a=s-17,f=.4):l==="猴"&&(s>=4&&s<23?(a=3,f=.8):s>=23&&(a=s-19,f=.5));let b=m.top-m.height*(a-1)-f;h>1&&(b-=(h-1)*m.height);const u=parseFloat(b.toFixed(2)),w=m.height*h;c={top:`${u}%`,left:`${m.left}%`,width:`${m.width}%`,height:`${w}%`},r={top:u,left:m.left,width:m.width,height:w}}d={id:n,num:s,stallCnt:h,coords:c,numericCoords:r,stallTitle:e.stallTitle||"N/A",stallImg:e.stallImg||void 0,stallLink:e.stallLink||void 0,promoData:[]},o.set(n,d)}const i=e.promoUser||"";if(i){const l={stallId:n,promoUser:i,promoAvatar:e.promoAvatar||"",promoHTML:e.promoHTML||"",promoLinks:st(i,e.promoLinks)};d.promoData.push(l)}}),Array.from(o.values())}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const H=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","鼠","牛","虎","兔","龍","蛇","馬","羊","商","特","猴","雞","狗"],rt=(t,o)=>{const e=o.toLowerCase().trim();return e===""?t:t.filter(n=>{const d=n.promoData.some(i=>i.promoUser.toLowerCase().includes(e));return n.id.toLowerCase().includes(e)||n.stallTitle.toLowerCase().includes(e)||d})},_=(t,o,e)=>{const n=t.id.substring(0,1),d=t.num,i=["狗","雞","猴","特","商"].includes(n),l=H.indexOf(n);if(e==="right"&&n>="A"&&n<="Q"&&(d===1||d===72))return null;if(e==="left"||e==="right"){const s=e==="right"?"prev":"next",h=!i&&!(d>=1&&d<=36),g=s==="next"?1:-1,m=h?-g:g;let c=d+m;for(;c>=1&&c<=72;){const r=o.find(a=>a.id.startsWith(n)&&a.num===c);if(r)return r.id;c+=m}return null}if(e==="up"||e==="down"){if(l===-1)return null;const s=e==="up"?1:-1;let h=l+s;for(;h>=0&&h<H.length;){const g=H[h],m=o.filter(c=>c.id.startsWith(g));if(m.length>0){let c;return i?e==="down"?c=m.sort((r,a)=>a.num-r.num)[0]:c=m.sort((r,a)=>r.num-a.num)[0]:(c=m.find(r=>r.num===d),c||(c=m.sort((r,a)=>Math.abs(r.num-d)-Math.abs(a.num-d))[0])),(c==null?void 0:c.id)||null}h+=s}}return null};/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function dt(t,o,e,n,d,i,l,s,h){const g=h?3.5:2.5,m=new Map,c=new Map;let r=!1,a=!1,f=!1,b=0,u=0,w=0,M=0,T=!1,N=null;const p=()=>{const I=t.offsetWidth,L=t.offsetHeight;if(I===0||L===0)return;const B=(e.offsetLeft+e.offsetWidth/2)/I*100,$=(e.offsetTop+e.offsetHeight/2)/L*100;if($<9.15||$>89.2){i.current.textContent="",i.prev.textContent="",i.next.textContent="";return}let A=null,G=1/0;for(const k of P){const q=Math.max(k.border.left-B,0,B-k.border.right),O=Math.max(k.border.top-$,0,$-k.border.bottom),z=q*q+O*O;z<G&&(G=z,A=k)}if(A){const k=H.indexOf(A.id);i.current.textContent=A.id,i.prev.textContent=k>0?H[k-1]:"",i.next.textContent=k<H.length-1?H[k+1]:""}else i.current.textContent="",i.prev.textContent="",i.next.textContent=""},E=()=>{const I=e.offsetWidth,L=e.offsetHeight,B=e.offsetLeft+I/2,$=e.offsetTop+L/2,R=-(B*g-I/2),Y=-($*g-L/2);n.style.backgroundPosition=`${R}px ${Y}px`,d.style.left=`${R}px`,d.style.top=`${Y}px`,p()},y=(I,L)=>{const B=e.offsetWidth,$=e.offsetHeight,R=t.offsetWidth,Y=t.offsetHeight,A=-B/2,G=-$/2,k=R-B/2,q=Y-$/2,O=Math.max(A,Math.min(I,k)),z=Math.max(G,Math.min(L,q));e.style.left=`${O}px`,e.style.top=`${z}px`;const J=i.current.parentElement;if(J){const Z=J.offsetWidth;let Q=0;O<0?Q=-O:O+Z>R&&(Q=R-(O+Z)),J.style.transform=`translateX(${Q}px) translateY(-50%)`}E()},x=I=>{var R;I.preventDefault(),r=!0,T=!1,N=I.target;const L=(R=I.touches)==null?void 0:R[0],B=L?L.clientX:I.clientX,$=L?L.clientY:I.clientY;b=B,u=$,w=e.offsetLeft,M=e.offsetTop,document.addEventListener("mousemove",C),document.addEventListener("touchmove",C,{passive:!1}),document.addEventListener("mouseup",S),document.addEventListener("touchend",S)},C=I=>{var A;if(!r)return;const L=(A=I.touches)==null?void 0:A[0],B=L?L.clientX:I.clientX,$=L?L.clientY:I.clientY,R=B-b,Y=$-u;!T&&(Math.abs(R)>5||Math.abs(Y)>5)&&(T=!0),y(w+R,M+Y)},S=()=>{r&&(r=!1,document.removeEventListener("mousemove",C),document.removeEventListener("touchmove",C),document.removeEventListener("mouseup",S),document.removeEventListener("touchend",S),!T&&N&&N.closest(".stall-area")&&s(N),N=null)},D=()=>{if(a=!0,n.style.backgroundSize=`${o.offsetWidth*g}px ${o.offsetHeight*g}px`,n.style.backgroundImage=`url('${o.src}')`,d.style.width=`${o.offsetWidth}px`,d.style.height=`${o.offsetHeight}px`,d.style.transform=`scale(${g})`,e.style.display="block",!f){const I=t.offsetWidth,L=t.offsetHeight,B=e.offsetWidth,$=e.offsetHeight;y((I-B)/2,(L-$)/2),f=!0}l.setAttribute("aria-pressed","true"),l.textContent="隱藏放大鏡",E()},X=()=>{a=!1,e.style.display="none",l.setAttribute("aria-pressed","false"),l.textContent="顯示放大鏡"},U=()=>{a?X():D()};return l.addEventListener("click",U),e.addEventListener("mousedown",x),e.addEventListener("touchstart",x,{passive:!1}),{addStall:I=>{const L=I.dataset.stallId;if(!L)return;const B=I.cloneNode(!0);d.appendChild(B),m.set(L,I),c.set(L,B)},addGroupArea:I=>{const L=I.cloneNode(!0);d.appendChild(L)},updateStallClass:(I,L,B)=>{const $=m.get(I);$&&$.classList.toggle(L,B);const R=c.get(I);R&&R.classList.toggle(L,B)},show:D,hide:X,toggle:U,isShown:()=>a}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const ct=["map-container","map-image","magnifier-wrapper","magnifier","magnifier-stall-layer","tooltip","modal","modal-close","modal-overlay","modal-title","modal-body","modal-footer","instructions-text","search-input","toggle-magnifier-btn","modal-magnifier-wrapper","modal-magnifier","modal-magnifier-stall-layer","modal-nav-controls","modal-nav-up","modal-nav-down","modal-nav-left","modal-nav-right","magnifier-row-indicator-container","magnifier-row-indicator-prev","magnifier-row-indicator-current","magnifier-row-indicator-next","modal-magnifier-row-indicator-container","modal-magnifier-row-indicator-prev","modal-magnifier-row-indicator-current","modal-magnifier-row-indicator-next","modal-vertical-stall-list","image-lightbox","image-lightbox-close","image-lightbox-image"];function mt(){const t={mapContainer:document.getElementById("map-container"),mapImage:document.getElementById("map-image"),magnifierWrapper:document.getElementById("magnifier-wrapper"),magnifier:document.getElementById("magnifier"),magnifierStallLayer:document.getElementById("magnifier-stall-layer"),magnifierRowIndicatorContainer:document.getElementById("magnifier-row-indicator-container"),magnifierRowIndicatorPrev:document.getElementById("magnifier-row-indicator-prev"),magnifierRowIndicatorCurrent:document.getElementById("magnifier-row-indicator-current"),magnifierRowIndicatorNext:document.getElementById("magnifier-row-indicator-next"),tooltip:document.getElementById("tooltip"),modal:document.getElementById("modal"),modalClose:document.getElementById("modal-close"),modalOverlay:document.getElementById("modal-overlay"),modalHeader:document.querySelector(".modal-header"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),modalFooter:document.getElementById("modal-footer"),instructionsEl:document.getElementById("instructions-text"),searchInput:document.getElementById("search-input"),toggleMagnifierBtn:document.getElementById("toggle-magnifier-btn"),modalMagnifierWrapper:document.getElementById("modal-magnifier-wrapper"),modalMagnifier:document.getElementById("modal-magnifier"),modalMagnifierStallLayer:document.getElementById("modal-magnifier-stall-layer"),modalMagnifierRowIndicatorContainer:document.getElementById("modal-magnifier-row-indicator-container"),modalMagnifierRowIndicatorPrev:document.getElementById("modal-magnifier-row-indicator-prev"),modalMagnifierRowIndicatorCurrent:document.getElementById("modal-magnifier-row-indicator-current"),modalMagnifierRowIndicatorNext:document.getElementById("modal-magnifier-row-indicator-next"),modalNavControls:document.getElementById("modal-nav-controls"),modalNavUp:document.getElementById("modal-nav-up"),modalNavDown:document.getElementById("modal-nav-down"),modalNavLeft:document.getElementById("modal-nav-left"),modalNavRight:document.getElementById("modal-nav-right"),modalVerticalStallList:document.getElementById("modal-vertical-stall-list"),imageLightbox:document.getElementById("image-lightbox"),imageLightboxClose:document.getElementById("image-lightbox-close"),imageLightboxImage:document.getElementById("image-lightbox-image")};for(const o in t)if(!t[o])throw new Error(`Essential DOM element not found: #${o}. The application cannot start.`);return t}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const V={selectedStallElement:null,stallIdToModalCloneMap:new Map,rowIdToModalGroupCloneMap:new Map};function ft(t,o,e,n){const d=new Set(P.filter(i=>i.isGrouped).map(i=>i.id));t.forEach(i=>{if(!i.coords)return;const l=document.createElement("div");l.className="stall-area",i.promoData.length>0&&l.classList.add("has-promo");const s=i.id.substring(0,1);d.has(s)&&l.classList.add("is-grouped-member"),l.dataset.stallId=i.id,l.style.top=i.coords.top,l.style.left=i.coords.left,l.style.width=i.coords.width,l.style.height=i.coords.height,l.setAttribute("aria-label",`Stall: ${i.stallTitle}`),i.num&&(l.textContent=i.num.toString().padStart(2,"0")),o.mapContainer.appendChild(l),e==null||e.addStall(l);const h=l.cloneNode(!0);o.modalMagnifierStallLayer.appendChild(h),n.stallIdToModalCloneMap.set(i.id,h)}),P.forEach(i=>{const l=document.createElement("div");if(l.className="stall-area stall-group-area",l.dataset.rowId=i.id,l.style.top=`${i.border.top}%`,l.style.left=`${i.border.left}%`,l.style.width=`${i.border.right-i.border.left}%`,l.style.height=`${i.border.bottom-i.border.top}%`,l.setAttribute("aria-label",`Row: ${i.id}`),l.textContent=i.id,i.isGrouped||l.classList.add("mobile-only-group"),o.mapContainer.appendChild(l),i.isGrouped){e==null||e.addGroupArea(l);const s=l.cloneNode(!0);o.modalMagnifierStallLayer.appendChild(s),n.rowIdToModalGroupCloneMap.set(i.id,s)}})}function K(t,o,e,n,d){const i=t.dataset.stallId;if(!i)return;n?n.updateStallClass(i,o,e):t.classList.toggle(o,e);const l=d.stallIdToModalCloneMap.get(i);l&&l.classList.toggle(o,e)}function ot(t,o,e){e.selectedStallElement&&K(e.selectedStallElement,"is-selected",!1,o,e),e.selectedStallElement=null,t.tooltip.classList.add("hidden")}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const v={wasMagnifierVisible:!1,isPanning:!1,panStartX:0,panStartY:0,initialBgX:0,initialBgY:0,panHappened:!1,clickTarget:null,animationFrameId:0,targetBgX:0,targetBgY:0};function ht(t,o,e){t&&(e.imageLightboxImage.src=t,e.imageLightboxImage.alt=o,e.imageLightbox.classList.remove("hidden"))}function ut(t){t.imageLightbox.classList.add("hidden"),t.imageLightboxImage.src=""}function gt(t,o,e,n){const{elements:d,isMobile:i}=t,{modalMagnifier:l,mapImage:s,modalMagnifierRowIndicatorContainer:h}=d,{modalMagnifierRowIndicatorPrev:g,modalMagnifierRowIndicatorCurrent:m,modalMagnifierRowIndicatorNext:c}=d;h.style.display="flex";let r=null;if(n){const a=n.id.substring(0,1);r=P.find(f=>f.id===a)??null}else{const a=i?4.5:1.8,f=l.offsetWidth,b=l.offsetHeight,u=s.offsetWidth,w=s.offsetHeight;if(u===0||w===0)return;const M=(f/2-o)/a,T=(b/2-e)/a,N=M/u*100,p=T/w*100;let E=1/0;for(const y of P){const x=Math.max(y.border.left-N,0,N-y.border.right),C=Math.max(y.border.top-p,0,p-y.border.bottom),S=x*x+C*C;S<E&&(E=S,r=y)}}if(r&&r.id==="範")m.textContent="",g.textContent="",c.textContent="";else if(h.style.display="flex",r){const a=H.indexOf(r.id);m.textContent=r.id,g.textContent=a>0?H[a-1]:"",c.textContent=a<H.length-1?H[a+1]:""}else m.textContent="",g.textContent="",c.textContent=""}function nt(t,o,e,n){const{elements:d,isMobile:i,allStalls:l,uiState:s}=t,{modalMagnifier:h,modalMagnifierStallLayer:g,mapImage:m}=d,c=i?4.5:1.8,r=h.offsetWidth,a=h.offsetHeight;if(r===0||a===0)return{clampedBgX:0,clampedBgY:0};const f=m.offsetWidth,b=m.offsetHeight;if(f===0||b===0)return{clampedBgX:0,clampedBgY:0};const u=f*c,w=b*c,M=Math.max(r-u,Math.min(o,0)),T=Math.max(a-w,Math.min(e,0));h.style.backgroundPosition=`${M}px ${T}px`,g.style.transform=`translate(${M}px, ${T}px) scale(${c})`;const N=r/c*.5,p=a/c*.5,E=-M/c-N,y=-T/c-p,x=(-M+r)/c+N,C=(-T+a)/c+p;return l.forEach(S=>{const D=s.stallIdToModalCloneMap.get(S.id);if(!D||!S.numericCoords)return;const{left:X,top:U,width:F,height:I}=S.numericCoords,L=X/100*f,B=U/100*b,$=L+F/100*f,R=B+I/100*b,Y=L<x&&$>E&&B<C&&R>y;D.classList.toggle("modal-map-hidden",!Y)}),P.forEach(S=>{const D=s.rowIdToModalGroupCloneMap.get(S.id);if(!D)return;const X=S.border.left/100*f,U=S.border.top/100*b,F=S.border.right/100*f,I=S.border.bottom/100*b,L=X<x&&F>E&&U<C&&I>y;D.classList.toggle("modal-map-hidden",!L)}),gt(t,M,T,n),{clampedBgX:M,clampedBgY:T}}function pt(t,o){const{elements:e,isMobile:n}=o,{modalMagnifierWrapper:d,modalMagnifier:i,modalMagnifierStallLayer:l,mapImage:s}=e;if(!t||!t.coords){d.style.display="none";return}d.style.display="block",d.style.cursor="grab";const h=n?4.5:1.8,g=i.offsetWidth,m=i.offsetHeight;if(g===0||m===0){d.style.display="none";return}const c=s.offsetWidth,r=s.offsetHeight,a=c*h,f=r*h;l.style.width=`${c}px`,l.style.height=`${r}px`,i.style.backgroundSize=`${a}px ${f}px`,i.style.backgroundImage=`url('${s.src}')`;const{left:b,top:u,width:w,height:M}=t.numericCoords;if([b,u,w,M].some(x=>typeof x!="number")){console.error("Could not parse stall coordinates for modal magnifier:",t.coords),d.style.display="none";return}const T=(b+w/2)/100*c,N=(u+M/2)/100*r,p=g/2-T*h,E=m/2-N*h;nt(o,p,E,t);let y=l.querySelector(".modal-stall-highlight");y||(y=document.createElement("div"),y.className="modal-stall-highlight",l.appendChild(y)),y.style.width=t.coords.width,y.style.height=t.coords.height,y.style.left=t.coords.left,y.style.top=t.coords.top,y.style.visibility="visible"}function W(t,o){var M,T,N;const{allStalls:e,elements:n,magnifierController:d,uiState:i,isMobile:l}=o,s=e.find(p=>p.id===t);if(!s)return;d&&n.modal.classList.contains("hidden")&&(v.wasMagnifierVisible=d.isShown(),v.wasMagnifierVisible&&d.hide());const h=i.selectedStallElement,g=((M=h==null?void 0:h.dataset.stallId)==null?void 0:M.substring(0,1))??null;ot(n,d,i);const m=document.querySelector(`.stall-area[data-stall-id="${t}"]`);m&&(i.selectedStallElement=m,K(m,"is-selected",!0,d,i)),n.modalTitle.textContent=`${s.id}: ${s.stallTitle}`;let c=s.stallImg?`<img src="${s.stallImg}" alt="Official Promo Image: ${s.stallTitle}" class="official-stall-image" />`:"";s.stallImg&&s.promoData.length>0&&(c+='<hr class="promo-section-separator">'),s.promoData.forEach((p,E)=>{E>0&&(c+='<div class="promo-entry-separator"></div>');const y=p.promoAvatar?p.promoAvatar:"https://images.plurk.com/3rbw6tg1lA5dEGpdKTL8j1.png";c+=`
      <div class="promo-entry">
          <div class="modal-user-info">
              <img src="${y}" alt="${p.promoUser}" class="modal-avatar">
              <span class="modal-username">${p.promoUser}</span>
          </div>
          <div class="promo-html-content">${p.promoHTML}</div>
      </div>`}),n.modalBody.innerHTML=c||"暫無宣傳資訊。",n.modalFooter.innerHTML="";const r=p=>{if(p&&p.href){const E=document.createElement("a");E.href=p.href,E.textContent=p.text,E.className="footer-link",E.target="_blank",E.rel="noopener noreferrer",n.modalFooter.appendChild(E)}};s.promoData.forEach(p=>p.promoLinks.forEach(r)),s.stallLink&&r({href:s.stallLink,text:"社團網站"});const a=rt(e,n.searchInput.value),f=s.id.substring(0,1),u=["猴","雞","狗","特","商"].includes(f);if(u){n.modalNavLeft.style.display="none",n.modalNavRight.style.display="none",n.modalNavUp.style.display="block",n.modalNavDown.style.display="block",n.modalNavUp.ariaLabel="往上一個攤位",n.modalNavDown.ariaLabel="往下一個攤位";let p,E=1;for(;s.num+E<=34;){const C=(T=a.find(S=>S.id.startsWith(f)&&S.num===s.num+E))==null?void 0:T.id;if(C){p=C;break}E+=1}let y,x=-1;for(;s.num+x>0;){const C=(N=a.find(S=>S.id.startsWith(f)&&S.num===s.num+x))==null?void 0:N.id;if(C){y=C;break}x-=1}p||(p=_(s,a,"up")),y||(y=_(s,a,"down")),n.modalNavUp.disabled=!p,n.modalNavUp.dataset.targetId=p??"",n.modalNavDown.disabled=!y,n.modalNavDown.dataset.targetId=y??"",n.modalNavLeft.disabled=!0,n.modalNavRight.disabled=!0}else{n.modalNavLeft.style.display="block",n.modalNavRight.style.display="block",n.modalNavUp.style.display="block",n.modalNavDown.style.display="block",n.modalNavUp.ariaLabel="往上一排",n.modalNavDown.ariaLabel="往下一排";const p={up:_(s,a,"up"),down:_(s,a,"down"),left:_(s,a,"left"),right:_(s,a,"right")};n.modalNavUp.disabled=!p.up,n.modalNavUp.dataset.targetId=p.up??"",n.modalNavDown.disabled=!p.down,n.modalNavDown.dataset.targetId=p.down??"",n.modalNavLeft.disabled=!p.left,n.modalNavLeft.dataset.targetId=p.left??"",n.modalNavRight.disabled=!p.right,n.modalNavRight.dataset.targetId=p.right??""}const{modalVerticalStallList:w}=n;if(u){f!==g&&(w.scrollTop=0),w.innerHTML="",w.style.display="flex";const p=e.filter(x=>x.id.startsWith(f)).sort((x,C)=>C.num-x.num),E=n.searchInput.value.toLowerCase().trim();p.forEach(x=>{const C=document.createElement("div");C.className="modal-vertical-stall-item",C.dataset.stallId=x.id,C.textContent=x.num.toString().padStart(2,"0"),x.promoData.length>0&&C.classList.add("has-promo");let S=!1;if(E!==""){const D=x.promoData.some(X=>X.promoUser.toLowerCase().includes(E));S=x.id.toLowerCase().includes(E)||x.stallTitle.toLowerCase().includes(E)||D}S&&C.classList.add("is-search-match"),x.id===t&&C.classList.add("is-selected"),w.appendChild(C)});const y=w.querySelector(".is-selected");y&&requestAnimationFrame(()=>{y.scrollIntoView({behavior:"smooth",block:"center"})})}else w.innerHTML="",w.style.display="none";document.body.classList.add("body-modal-open"),n.modal.classList.remove("hidden"),n.modalNavControls.style.display="grid",n.modal.setAttribute("aria-hidden","true"),pt(s,o)}function j(t){const{elements:o,magnifierController:e,uiState:n}=t;document.body.classList.remove("body-modal-open"),o.modal.classList.add("hidden"),o.modalNavControls.style.display="none",o.modal.setAttribute("aria-hidden","true"),ot(o,e,n),e&&v.wasMagnifierVisible&&e.show(),v.wasMagnifierVisible=!1,o.modalMagnifierWrapper.style.display="none",o.modalVerticalStallList.style.display="none"}function bt(t,o){var s;const{allStalls:e,uiState:n}=o,d=t.closest(".stall-group-area"),i=t.closest(".stall-area:not(.stall-group-area)"),l=(s=n.selectedStallElement)==null?void 0:s.dataset.stallId;if(d!=null&&d.dataset.rowId){const h=d.dataset.rowId;if(h===(l==null?void 0:l.substring(0,1)))return;const g=e.filter(m=>m.id.startsWith(h)).sort((m,c)=>c.num-m.num);g.length>0&&W(g[0].id,o)}else if(i!=null&&i.dataset.stallId){const h=i.dataset.stallId;if(h===l)return;W(h,o)}}function wt(t){const{elements:o}=t;o.modalNavControls.addEventListener("click",r=>{const a=r.target.closest(".modal-nav-btn");a!=null&&a.dataset.targetId&&W(a.dataset.targetId,t)}),o.modalVerticalStallList.addEventListener("click",r=>{const a=r.target.closest(".modal-vertical-stall-item");a!=null&&a.dataset.stallId&&W(a.dataset.stallId,t)});const{modalMagnifierWrapper:e,modalMagnifier:n,modalMagnifierStallLayer:d}=o,i=()=>{v.isPanning&&(nt(t,v.targetBgX,v.targetBgY),v.animationFrameId=requestAnimationFrame(i))},l=r=>{var M;if(!v.isPanning)return;r.type==="touchmove"&&r.preventDefault();const a=(M=r.touches)==null?void 0:M[0],f=a?a.clientX:r.clientX,b=a?a.clientY:r.clientY,u=f-v.panStartX,w=b-v.panStartY;!v.panHappened&&(Math.abs(u)>5||Math.abs(w)>5)&&(v.panHappened=!0,e.style.cursor="grabbing"),v.panHappened&&(v.targetBgX=v.initialBgX+u,v.targetBgY=v.initialBgY+w)},s=()=>{cancelAnimationFrame(v.animationFrameId),document.removeEventListener("mousemove",l),document.removeEventListener("touchmove",l),document.removeEventListener("mouseup",s),document.removeEventListener("touchend",s),!v.panHappened&&v.clickTarget&&bt(v.clickTarget,t),v.isPanning=!1,v.clickTarget=null,e.style.cursor="grab",n.style.transition="",d.style.transition=""},h=r=>{var p,E;const a=r.target;if(a.closest("#modal-vertical-stall-list"))return;const f=a.closest(".stall-group-area"),b=(p=t.uiState.selectedStallElement)==null?void 0:p.dataset.stallId;if(f&&b){const y=f.dataset.rowId,x=b.substring(0,1);if(y===x)return}if("button"in r&&r.button!==0)return;v.isPanning=!0,v.panHappened=!1,v.clickTarget=r.target;const u=(E=r.touches)==null?void 0:E[0],w=u?u.clientX:r.clientX,M=u?u.clientY:r.clientY;v.panStartX=w,v.panStartY=M;const T=new DOMMatrix(window.getComputedStyle(d).transform);v.initialBgX=T.e,v.initialBgY=T.f,v.targetBgX=v.initialBgX,v.targetBgY=v.initialBgY,n.style.transition="none",d.style.transition="none";const N=d.querySelector(".modal-stall-highlight");N&&(N.style.visibility="hidden"),cancelAnimationFrame(v.animationFrameId),v.animationFrameId=requestAnimationFrame(i),document.addEventListener("mousemove",l),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("mouseup",s,{once:!0}),document.addEventListener("touchend",s,{once:!0})};e.addEventListener("mousedown",h),e.addEventListener("touchstart",h,{passive:!1});const g=()=>ut(o);o.modalBody.addEventListener("click",r=>{const a=r.target;if(a instanceof HTMLImageElement){let f="";a.classList.contains("official-stall-image")?f=a.src:a.closest(".promo-html-content")&&a.parentElement instanceof HTMLAnchorElement&&(f=a.alt,r.stopPropagation(),r.preventDefault()),ht(f,a.alt,o)}}),o.imageLightboxClose.addEventListener("click",g),o.imageLightbox.addEventListener("click",r=>{(r.target===o.imageLightbox||r.target===o.imageLightbox.querySelector(".lightbox-overlay"))&&g()}),o.modalClose.addEventListener("click",()=>j(t)),o.modalOverlay.addEventListener("click",()=>j(t)),document.addEventListener("keydown",r=>{if(!o.imageLightbox.classList.contains("hidden")){r.key==="Escape"&&g();return}if(!o.modal.classList.contains("hidden"))switch(r.key){case"Escape":j(t);break;case"ArrowUp":o.modalNavUp.click();break;case"ArrowDown":o.modalNavDown.click();break;case"ArrowLeft":o.modalNavLeft.click();break;case"ArrowRight":o.modalNavRight.click();break}});const{modalNavControls:m,tooltip:c}=o;m.addEventListener("mouseover",r=>{const a=r.target.closest(".modal-nav-btn");if(a instanceof HTMLButtonElement&&!a.disabled){const f=a.ariaLabel;if(f){c.innerHTML=f;const b=a.getBoundingClientRect();c.classList.remove("hidden");const u=c.getBoundingClientRect(),w=b.top-u.height-8,M=b.left+b.width/2-u.width/2;c.style.left=`${M}px`,c.style.top=`${w}px`}}else c.classList.add("hidden")}),m.addEventListener("mouseleave",()=>{c.classList.add("hidden")})}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function vt(t){const o=()=>ct.every(n=>document.getElementById(n)),e=()=>{o()?t():requestAnimationFrame(e)};e()}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function yt(t){P.forEach(o=>{const e=document.createElement("div");e.className="debug-border",e.style.top=`${o.border.top}%`,e.style.left=`${o.border.left}%`,e.style.width=`${o.border.right-o.border.left}%`,e.style.height=`${o.border.bottom-o.border.top}%`;const n=document.createElement("span");n.textContent=o.id,e.appendChild(n),t.appendChild(e)})}async function It(){const t=mt();new URLSearchParams(window.location.search).get("debug")==="true"&&t.mapContainer.classList.add("debug-mode"),t.instructionsEl.textContent="正在載入地圖與攤位資料",t.instructionsEl.classList.add("loading-text");const e=new Promise((n,d)=>{t.mapImage.complete?n():(t.mapImage.onload=()=>n(),t.mapImage.onerror=()=>d(new Error("Map image failed to load.")))});try{const[n]=await Promise.all([it(),e]);if(t.instructionsEl.classList.remove("loading-text"),n.length===0){t.mapContainer.innerHTML='<p style="color: red; padding: 20px;"><b>無法載入攤位資料：</b><br>請檢查您的 Google Sheet 是否已「發佈至網路」、網址是否正確，或檢查您的網路連線。</p>',t.instructionsEl.textContent="載入失敗";return}const d=lt(n),l=window.matchMedia("(max-width: 768px)").matches,s={allStalls:d,elements:t,magnifierController:null,uiState:V,isMobile:l},h=c=>{const r=c.closest(".stall-group-area"),a=c.closest(".stall-area:not(.stall-group-area)");if(r!=null&&r.dataset.rowId){const f=r.dataset.rowId,b=d.filter(u=>u.id.startsWith(f)).sort((u,w)=>w.num-u.num);b.length>0&&W(b[0].id,s)}else a!=null&&a.dataset.stallId&&W(a.dataset.stallId,s)},g=dt(t.mapContainer,t.mapImage,t.magnifierWrapper,t.magnifier,t.magnifierStallLayer,{prev:t.magnifierRowIndicatorPrev,current:t.magnifierRowIndicatorCurrent,next:t.magnifierRowIndicatorNext},t.toggleMagnifierBtn,h,l);s.magnifierController=g,ft(d,t,g,V),yt(t.mapContainer),wt(s),t.searchInput.addEventListener("input",()=>{const c=t.searchInput.value.toLowerCase().trim(),r=new Set;d.forEach(a=>{const f=document.querySelector(`.stall-area[data-stall-id="${a.id}"]`);if(!f)return;let b=!1;if(c!==""){const u=a.promoData.some(w=>w.promoUser.toLowerCase().includes(c));b=a.id.toLowerCase().includes(c)||a.stallTitle.toLowerCase().includes(c)||u}K(f,"is-search-match",b,g,V),b&&r.add(a.id.substring(0,1))}),P.forEach(a=>{document.querySelectorAll(`.stall-group-area[data-row-id="${a.id}"]`).forEach(b=>{const u=r.has(a.id);b.classList.toggle("is-search-match",u)})})});const m=c=>{const r=c.target;r.closest("#magnifier-wrapper")||(c.type==="touchstart"&&c.preventDefault(),h(r))};l?(t.instructionsEl.textContent="點擊按鈕可用放大鏡，或直接點擊攤位查看宣傳。",t.mapContainer.addEventListener("mousedown",m,{passive:!1}),t.mapContainer.addEventListener("touchstart",m,{passive:!1})):(t.instructionsEl.textContent="點擊按鈕顯示/隱藏放大鏡並拖曳。點擊攤位(含放大鏡內)可看宣傳。",document.addEventListener("mousemove",c=>{V.selectedStallElement||(t.tooltip.style.left=`${c.clientX+15}px`,t.tooltip.style.top=`${c.clientY+15}px`)}),t.mapContainer.addEventListener("mouseover",c=>{var f;const a=c.target.closest(".stall-area:not(.stall-group-area)");if(a&&!V.selectedStallElement){const b=a.dataset.stallId,u=d.find(w=>w.id===b);if(u){const w=(f=u.promoData)==null?void 0:f[0];t.tooltip.innerHTML=`<strong>${u.stallTitle}</strong><br><small>${u.id}${w!=null&&w.promoUser?` / ${w.promoUser}`:""}</small>`,t.tooltip.classList.remove("hidden")}}}),t.mapContainer.addEventListener("mouseout",c=>{c.target.classList.contains("stall-area")&&t.tooltip.classList.add("hidden")}),t.mapContainer.addEventListener("mousedown",m))}catch(n){console.error("Failed to initialize app:",n),t.instructionsEl.classList.remove("loading-text"),t.instructionsEl.textContent="地圖或資料載入失敗，請重新整理頁面。"}}vt(It);
