(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const tt="https://docs.google.com/spreadsheets/d/e/2PACX-1vSekTVRYingSPdcpjSzVazPOJRJr_SxAyQV1lvqvgzvoW6BtnP8aEoVOo1sZSF6tJ27tLXv7JvxCPP9/pub?output=csv";function et(t){const i=t.trim().replace(/\r\n/g,`
`).split(`
`);if(i.length<2)return[];const e=n=>{const l=[];let a="",f=!1;for(let g=0;g<n.length;g++){const m=n[g];m==='"'?f&&n[g+1]==='"'?(a+='"',g++):f=!f:m===","&&!f?(l.push(a),a=""):a+=m}return l.push(a),l},o=e(i[1]).map(n=>n.trim()),r=[];for(let n=2;n<i.length;n++){const l=i[n];if(!l.trim())continue;const a=e(l),f={};let g=!1;o.forEach((m,s)=>{const d=a[s]||"";f[m]=d,d.trim()!==""&&(g=!0)}),g&&r.push(f)}return r}async function it(){const t=`${tt}&_=${Date.now()}`;try{const i=await fetch(t);if(i.ok){const e=await i.text();return et(e)}console.warn(`Initial fetch with timestamp failed with status: ${i.status}. Retrying without timestamp.`)}catch(i){console.warn("Initial fetch with timestamp failed with a network error. Retrying without timestamp.",i)}console.log("Attempting fallback fetch without cache-busting timestamp.");try{const i=await fetch(tt);if(!i.ok)throw new Error(`Fallback fetch failed: ${i.status} ${i.statusText}`);const e=await i.text();return et(e)}catch(i){return console.error("Error fetching or parsing stall data after fallback:",i),[]}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const P=[{id:"A",num:1,coords:{top:87.8,left:91,width:1.05,height:1.4},border:{top:86.15,left:52.5,bottom:89.2,right:92.05}},{id:"B",num:1,coords:{top:83.1,left:91,width:1.05,height:1.4},border:{top:81.45,left:52.5,bottom:84.5,right:92.05}},{id:"C",num:1,coords:{top:78.4,left:91,width:1.05,height:1.4},border:{top:76.75,left:52.5,bottom:79.8,right:92.05}},{id:"D",num:1,coords:{top:73.5,left:91,width:1.05,height:1.4},border:{top:71.85,left:52.5,bottom:74.9,right:92.05}},{id:"E",num:1,coords:{top:68.5,left:91,width:1.05,height:1.4},border:{top:66.85,left:52.5,bottom:69.9,right:92.05}},{id:"F",num:1,coords:{top:63.9,left:91,width:1.05,height:1.4},border:{top:62.25,left:52.5,bottom:65.3,right:92.05}},{id:"G",num:1,coords:{top:59.1,left:91,width:1.05,height:1.4},border:{top:57.45,left:52.5,bottom:60.5,right:92.05}},{id:"H",num:1,coords:{top:54.3,left:91,width:1.05,height:1.4},border:{top:52.65,left:52.5,bottom:55.7,right:92.05}},{id:"I",num:1,coords:{top:49.5,left:91,width:1.05,height:1.4},border:{top:47.85,left:52.5,bottom:50.9,right:92.05}},{id:"J",num:1,coords:{top:44.5,left:91,width:1.05,height:1.4},border:{top:42.85,left:52.5,bottom:45.9,right:92.05}},{id:"K",num:1,coords:{top:39.6,left:91,width:1.05,height:1.4},border:{top:37.95,left:52.5,bottom:41,right:92.05}},{id:"L",num:1,coords:{top:34.8,left:91,width:1.05,height:1.4},border:{top:33.15,left:52.5,bottom:36.2,right:92.05}},{id:"M",num:1,coords:{top:30.1,left:91,width:1.05,height:1.4},border:{top:28.45,left:52.5,bottom:31.5,right:92.05}},{id:"N",num:1,coords:{top:25.2,left:91,width:1.05,height:1.4},border:{top:23.55,left:52.5,bottom:26.6,right:92.05}},{id:"O",num:1,coords:{top:20.4,left:91,width:1.05,height:1.4},border:{top:18.75,left:52.5,bottom:21.8,right:92.05}},{id:"P",num:1,coords:{top:15.6,left:91,width:1.05,height:1.4},border:{top:13.95,left:52.5,bottom:17,right:92.05}},{id:"Q",num:1,coords:{top:10.8,left:91,width:1.05,height:1.4},border:{top:9.15,left:52.5,bottom:12.2,right:92.05}},{id:"R",num:1,coords:{top:87.8,left:46.3,width:1.05,height:1.4},border:{top:86.15,left:7.8,bottom:89.2,right:47.35}},{id:"S",num:1,coords:{top:83.1,left:46.3,width:1.05,height:1.4},border:{top:81.45,left:7.8,bottom:84.5,right:47.35}},{id:"T",num:1,coords:{top:78.4,left:46.3,width:1.05,height:1.4},border:{top:76.75,left:7.8,bottom:79.8,right:47.35}},{id:"U",num:1,coords:{top:73.5,left:46.3,width:1.05,height:1.4},border:{top:71.85,left:7.8,bottom:74.9,right:47.35}},{id:"V",num:1,coords:{top:68.7,left:46.3,width:1.05,height:1.4},border:{top:67.05,left:7.8,bottom:70.1,right:47.35}},{id:"W",num:1,coords:{top:63.9,left:46.3,width:1.05,height:1.4},border:{top:62.25,left:7.8,bottom:65.3,right:47.35}},{id:"X",num:1,coords:{top:59.1,left:46.3,width:1.05,height:1.4},border:{top:57.45,left:7.8,bottom:60.5,right:47.35}},{id:"Y",num:1,coords:{top:54.3,left:46.3,width:1.05,height:1.4},border:{top:52.65,left:7.8,bottom:55.7,right:47.35}},{id:"Z",num:1,coords:{top:49.5,left:46.3,width:1.05,height:1.4},border:{top:47.85,left:7.8,bottom:50.9,right:47.35}},{id:"鼠",num:1,coords:{top:44.5,left:46.3,width:1.05,height:1.4},border:{top:42.85,left:7.8,bottom:45.9,right:47.35}},{id:"牛",num:1,coords:{top:39.6,left:46.3,width:1.05,height:1.4},border:{top:37.95,left:7.8,bottom:41,right:47.35}},{id:"虎",num:1,coords:{top:34.9,left:46.3,width:1.05,height:1.4},border:{top:33.25,left:7.8,bottom:36.3,right:47.35}},{id:"兔",num:1,coords:{top:30.1,left:46.3,width:1.05,height:1.4},border:{top:28.45,left:7.8,bottom:31.5,right:47.35}},{id:"龍",num:1,coords:{top:25.2,left:46.3,width:1.05,height:1.4},border:{top:23.55,left:7.8,bottom:26.6,right:47.35}},{id:"蛇",num:1,coords:{top:20.4,left:46.3,width:1.05,height:1.4},border:{top:18.75,left:7.8,bottom:21.8,right:47.35}},{id:"馬",num:1,coords:{top:15.6,left:46.3,width:1.05,height:1.4},border:{top:13.95,left:7.8,bottom:17,right:47.35}},{id:"羊",num:1,coords:{top:10.8,left:46.3,width:1.05,height:1.4},border:{top:9.15,left:7.8,bottom:12.2,right:47.35}},{id:"猴",num:1,coords:{top:73.5,left:4.5,width:1.1,height:1.44},border:{top:52.7,left:4.5,bottom:74.9,right:5.55},isGrouped:!0},{id:"雞",num:1,coords:{top:43.7,left:4.5,width:1.1,height:1.44},border:{top:23,left:4.5,bottom:45.6,right:5.55},isGrouped:!0},{id:"狗",num:1,coords:{top:18.2,left:4.5,width:1.1,height:1.44},border:{top:7.5,left:4.5,bottom:19.8,right:5.55},isGrouped:!0},{id:"特",num:1,coords:{top:84.4,left:4.15,width:1.8,height:2.41},border:{top:77.15,left:4.15,bottom:87.2,right:5.75},isGrouped:!0},{id:"商",num:1,coords:{top:89.5,left:4.15,width:1.8,height:2.41},border:{top:87.5,left:4.15,bottom:91.5,right:5.75},isGrouped:!0},{id:"範",num:1,coords:{top:.5,left:91,width:5,height:5},border:{top:.5,left:86,bottom:5.5,right:96}}];/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const at=new Map(P.map(t=>[t.id,t]));function st(t,i){return i?i.split(";").map((e,o)=>{const r=`${t}-宣傳車${o+1}`,n=e.trim();return{text:r,href:n}}).filter(e=>e!==null&&!!e.text&&!!e.href):[]}function lt(t){const i=new Map;return t.forEach(e=>{const o=e.id||e.stallId;if(!o)return;let r=i.get(o);if(!r){const l=o.substring(0,1),a=parseInt(e.num,10),f=parseInt(e.stallCnt,10)||1,g=at.get(l);if(!g||isNaN(a)){console.warn(`Could not calculate position for stall ID: ${o}. Skipping base creation.`);return}const m=g.coords;let s,d;if(l!=="狗"&&l!=="雞"&&l!=="猴"&&l!=="特"&&l!=="商"){const c=a>36?72-a:a;let h=0,u=m.top,w=m.left;a>24&&a<=48?h=1.75:a<=12||a>=61?h=0:h=.9,a>36?(u=u-m.height-.25,w=m.left-c%72*m.width-h):(w=m.left-(c-1)*m.width-h,f>1&&(w-=(f-1)*m.width));const b=parseFloat(w.toFixed(2)),S=m.width*f;s={top:`${u}%`,left:`${b}%`,width:`${S}%`,height:`${m.height}%`},d={top:u,left:b,width:S,height:m.height}}else{let c=a,h=0;l==="狗"?a>=4&&a<16?(c=3,h=.8):a>=16&&(c=a-12,h=.4):l==="雞"?a>=4&&a<21?(c=3,h=.8):a>=21&&(c=a-17,h=.4):l==="猴"&&(a>=4&&a<23?(c=3,h=.8):a>=23&&(c=a-19,h=.5));let u=m.top-m.height*(c-1)-h;f>1&&(u-=(f-1)*m.height);const w=parseFloat(u.toFixed(2)),b=m.height*f;s={top:`${w}%`,left:`${m.left}%`,width:`${m.width}%`,height:`${b}%`},d={top:w,left:m.left,width:m.width,height:b}}r={id:o,num:a,stallCnt:f,coords:s,numericCoords:d,stallTitle:e.stallTitle||"N/A",stallImg:e.stallImg||void 0,stallLink:e.stallLink||void 0,promoData:[]},i.set(o,r)}const n=e.promoUser||"";if(n){const l={stallId:o,promoUser:n,promoAvatar:e.promoAvatar||"",promoHTML:e.promoHTML||"",promoLinks:st(n,e.promoLinks)};r.promoData.push(l)}}),Array.from(i.values())}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const H=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","鼠","牛","虎","兔","龍","蛇","馬","羊","商","特","猴","雞","狗"],rt=(t,i)=>{const e=i.toLowerCase().trim();return e===""?t:t.filter(o=>{const r=o.promoData.some(n=>n.promoUser.toLowerCase().includes(e));return o.id.toLowerCase().includes(e)||o.stallTitle.toLowerCase().includes(e)||r})},_=(t,i,e)=>{const o=t.id.substring(0,1),r=t.num,n=["狗","雞","猴","特","商"].includes(o),l=H.indexOf(o);if(e==="right"&&o>="A"&&o<="Q"&&(r===1||r===72))return null;if(e==="left"||e==="right"){const a=e==="right"?"prev":"next",f=!n&&!(r>=1&&r<=36),g=a==="next"?1:-1,m=f?-g:g;let s=r+m;for(;s>=1&&s<=72;){const d=i.find(c=>c.id.startsWith(o)&&c.num===s);if(d)return d.id;s+=m}return null}if(e==="up"||e==="down"){if(l===-1)return null;const a=e==="up"?1:-1;let f=l+a;for(;f>=0&&f<H.length;){const g=H[f],m=i.filter(s=>s.id.startsWith(g));if(m.length>0){let s;return n?e==="down"?s=m.sort((d,c)=>c.num-d.num)[0]:s=m.sort((d,c)=>d.num-c.num)[0]:(s=m.find(d=>d.num===r),s||(s=m.sort((d,c)=>Math.abs(d.num-r)-Math.abs(c.num-r))[0])),(s==null?void 0:s.id)||null}f+=a}}return null};/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function dt(t,i,e,o,r,n,l,a,f){const g=f?3.5:2.5,m=new Map,s=new Map;let d=!1,c=!1,h=!1,u=0,w=0,b=0,S=0,T=!1,N=null;const p=()=>{const I=t.offsetWidth,L=t.offsetHeight;if(I===0||L===0)return;const B=(e.offsetLeft+e.offsetWidth/2)/I*100,$=(e.offsetTop+e.offsetHeight/2)/L*100;if($<9.15||$>89.2){n.current.textContent="",n.prev.textContent="",n.next.textContent="";return}let A=null,G=1/0;for(const k of P){const q=Math.max(k.border.left-B,0,B-k.border.right),O=Math.max(k.border.top-$,0,$-k.border.bottom),z=q*q+O*O;z<G&&(G=z,A=k)}if(A){const k=H.indexOf(A.id);n.current.textContent=A.id,n.prev.textContent=k>0?H[k-1]:"",n.next.textContent=k<H.length-1?H[k+1]:""}else n.current.textContent="",n.prev.textContent="",n.next.textContent=""},E=()=>{const I=e.offsetWidth,L=e.offsetHeight,B=e.offsetLeft+I/2,$=e.offsetTop+L/2,R=-(B*g-I/2),D=-($*g-L/2);o.style.backgroundPosition=`${R}px ${D}px`,r.style.left=`${R}px`,r.style.top=`${D}px`,p()},y=(I,L)=>{const B=e.offsetWidth,$=e.offsetHeight,R=t.offsetWidth,D=t.offsetHeight,A=-B/2,G=-$/2,k=R-B/2,q=D-$/2,O=Math.max(A,Math.min(I,k)),z=Math.max(G,Math.min(L,q));e.style.left=`${O}px`,e.style.top=`${z}px`;const J=n.current.parentElement;if(J){const Z=J.offsetWidth;let Q=0;O<0?Q=-O:O+Z>R&&(Q=R-(O+Z)),J.style.transform=`translateX(${Q}px) translateY(-50%)`}E()},M=I=>{var R;I.preventDefault(),d=!0,T=!1,N=I.target;const L=(R=I.touches)==null?void 0:R[0],B=L?L.clientX:I.clientX,$=L?L.clientY:I.clientY;u=B,w=$,b=e.offsetLeft,S=e.offsetTop,document.addEventListener("mousemove",C),document.addEventListener("touchmove",C,{passive:!1}),document.addEventListener("mouseup",x),document.addEventListener("touchend",x)},C=I=>{var A;if(!d)return;const L=(A=I.touches)==null?void 0:A[0],B=L?L.clientX:I.clientX,$=L?L.clientY:I.clientY,R=B-u,D=$-w;!T&&(Math.abs(R)>5||Math.abs(D)>5)&&(T=!0),y(b+R,S+D)},x=()=>{d&&(d=!1,document.removeEventListener("mousemove",C),document.removeEventListener("touchmove",C),document.removeEventListener("mouseup",x),document.removeEventListener("touchend",x),!T&&N&&N.closest(".stall-area")&&a(N),N=null)},Y=()=>{if(c=!0,o.style.backgroundSize=`${i.offsetWidth*g}px ${i.offsetHeight*g}px`,o.style.backgroundImage=`url('${i.src}')`,r.style.width=`${i.offsetWidth}px`,r.style.height=`${i.offsetHeight}px`,r.style.transform=`scale(${g})`,e.style.display="block",!h){const I=t.offsetWidth,L=t.offsetHeight,B=e.offsetWidth,$=e.offsetHeight;y((I-B)/2,(L-$)/2),h=!0}l.setAttribute("aria-pressed","true"),l.textContent="隱藏放大鏡",E()},X=()=>{c=!1,e.style.display="none",l.setAttribute("aria-pressed","false"),l.textContent="顯示放大鏡"},U=()=>{c?X():Y()};return l.addEventListener("click",U),e.addEventListener("mousedown",M),e.addEventListener("touchstart",M,{passive:!1}),{addStall:I=>{const L=I.dataset.stallId;if(!L)return;const B=I.cloneNode(!0);r.appendChild(B),m.set(L,I),s.set(L,B)},addGroupArea:I=>{const L=I.cloneNode(!0);r.appendChild(L)},updateStallClass:(I,L,B)=>{const $=m.get(I);$&&$.classList.toggle(L,B);const R=s.get(I);R&&R.classList.toggle(L,B)},show:Y,hide:X,toggle:U,isShown:()=>c}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const ct=["map-container","map-image","magnifier-wrapper","magnifier","magnifier-stall-layer","tooltip","modal","modal-close","modal-overlay","modal-title","modal-body","modal-footer","instructions-text","search-input","toggle-magnifier-btn","modal-magnifier-wrapper","modal-magnifier","modal-magnifier-stall-layer","modal-nav-controls","modal-nav-up","modal-nav-down","modal-nav-left","modal-nav-right","magnifier-row-indicator-container","magnifier-row-indicator-prev","magnifier-row-indicator-current","magnifier-row-indicator-next","modal-magnifier-row-indicator-container","modal-magnifier-row-indicator-prev","modal-magnifier-row-indicator-current","modal-magnifier-row-indicator-next","modal-vertical-stall-list"];function mt(){const t={mapContainer:document.getElementById("map-container"),mapImage:document.getElementById("map-image"),magnifierWrapper:document.getElementById("magnifier-wrapper"),magnifier:document.getElementById("magnifier"),magnifierStallLayer:document.getElementById("magnifier-stall-layer"),magnifierRowIndicatorContainer:document.getElementById("magnifier-row-indicator-container"),magnifierRowIndicatorPrev:document.getElementById("magnifier-row-indicator-prev"),magnifierRowIndicatorCurrent:document.getElementById("magnifier-row-indicator-current"),magnifierRowIndicatorNext:document.getElementById("magnifier-row-indicator-next"),tooltip:document.getElementById("tooltip"),modal:document.getElementById("modal"),modalClose:document.getElementById("modal-close"),modalOverlay:document.getElementById("modal-overlay"),modalHeader:document.querySelector(".modal-header"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),modalFooter:document.getElementById("modal-footer"),instructionsEl:document.getElementById("instructions-text"),searchInput:document.getElementById("search-input"),toggleMagnifierBtn:document.getElementById("toggle-magnifier-btn"),modalMagnifierWrapper:document.getElementById("modal-magnifier-wrapper"),modalMagnifier:document.getElementById("modal-magnifier"),modalMagnifierStallLayer:document.getElementById("modal-magnifier-stall-layer"),modalMagnifierRowIndicatorContainer:document.getElementById("modal-magnifier-row-indicator-container"),modalMagnifierRowIndicatorPrev:document.getElementById("modal-magnifier-row-indicator-prev"),modalMagnifierRowIndicatorCurrent:document.getElementById("modal-magnifier-row-indicator-current"),modalMagnifierRowIndicatorNext:document.getElementById("modal-magnifier-row-indicator-next"),modalNavControls:document.getElementById("modal-nav-controls"),modalNavUp:document.getElementById("modal-nav-up"),modalNavDown:document.getElementById("modal-nav-down"),modalNavLeft:document.getElementById("modal-nav-left"),modalNavRight:document.getElementById("modal-nav-right"),modalVerticalStallList:document.getElementById("modal-vertical-stall-list")};for(const i in t)if(!t[i])throw new Error(`Essential DOM element not found: #${i}. The application cannot start.`);return t}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const V={selectedStallElement:null,stallIdToModalCloneMap:new Map,rowIdToModalGroupCloneMap:new Map};function ft(t,i,e,o){const r=new Set(P.filter(n=>n.isGrouped).map(n=>n.id));t.forEach(n=>{if(!n.coords)return;const l=document.createElement("div");l.className="stall-area",n.promoData.length>0&&l.classList.add("has-promo");const a=n.id.substring(0,1);r.has(a)&&l.classList.add("is-grouped-member"),l.dataset.stallId=n.id,l.style.top=n.coords.top,l.style.left=n.coords.left,l.style.width=n.coords.width,l.style.height=n.coords.height,l.setAttribute("aria-label",`Stall: ${n.stallTitle}`),n.num&&(l.textContent=n.num.toString().padStart(2,"0")),i.mapContainer.appendChild(l),e==null||e.addStall(l);const f=l.cloneNode(!0);i.modalMagnifierStallLayer.appendChild(f),o.stallIdToModalCloneMap.set(n.id,f)}),P.forEach(n=>{const l=document.createElement("div");if(l.className="stall-area stall-group-area",l.dataset.rowId=n.id,l.style.top=`${n.border.top}%`,l.style.left=`${n.border.left}%`,l.style.width=`${n.border.right-n.border.left}%`,l.style.height=`${n.border.bottom-n.border.top}%`,l.setAttribute("aria-label",`Row: ${n.id}`),l.textContent=n.id,n.isGrouped||l.classList.add("mobile-only-group"),i.mapContainer.appendChild(l),n.isGrouped){e==null||e.addGroupArea(l);const a=l.cloneNode(!0);i.modalMagnifierStallLayer.appendChild(a),o.rowIdToModalGroupCloneMap.set(n.id,a)}})}function K(t,i,e,o,r){const n=t.dataset.stallId;if(!n)return;o?o.updateStallClass(n,i,e):t.classList.toggle(i,e);const l=r.stallIdToModalCloneMap.get(n);l&&l.classList.toggle(i,e)}function ot(t,i,e){e.selectedStallElement&&K(e.selectedStallElement,"is-selected",!1,i,e),e.selectedStallElement=null,t.tooltip.classList.add("hidden")}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const v={wasMagnifierVisible:!1,isPanning:!1,panStartX:0,panStartY:0,initialBgX:0,initialBgY:0,panHappened:!1,clickTarget:null,animationFrameId:0,targetBgX:0,targetBgY:0};function ht(t,i,e,o){const{elements:r,isMobile:n}=t,{modalMagnifier:l,mapImage:a,modalMagnifierRowIndicatorContainer:f}=r,{modalMagnifierRowIndicatorPrev:g,modalMagnifierRowIndicatorCurrent:m,modalMagnifierRowIndicatorNext:s}=r;f.style.display="flex";let d=null;if(o){const c=o.id.substring(0,1);d=P.find(h=>h.id===c)??null}else{const c=n?4.5:1.8,h=l.offsetWidth,u=l.offsetHeight,w=a.offsetWidth,b=a.offsetHeight;if(w===0||b===0)return;const S=(h/2-i)/c,T=(u/2-e)/c,N=S/w*100,p=T/b*100;let E=1/0;for(const y of P){const M=Math.max(y.border.left-N,0,N-y.border.right),C=Math.max(y.border.top-p,0,p-y.border.bottom),x=M*M+C*C;x<E&&(E=x,d=y)}}if(d&&d.id==="範")m.textContent="",g.textContent="",s.textContent="";else if(f.style.display="flex",d){const c=H.indexOf(d.id);m.textContent=d.id,g.textContent=c>0?H[c-1]:"",s.textContent=c<H.length-1?H[c+1]:""}else m.textContent="",g.textContent="",s.textContent=""}function nt(t,i,e,o){const{elements:r,isMobile:n,allStalls:l,uiState:a}=t,{modalMagnifier:f,modalMagnifierStallLayer:g,mapImage:m}=r,s=n?4.5:1.8,d=f.offsetWidth,c=f.offsetHeight;if(d===0||c===0)return{clampedBgX:0,clampedBgY:0};const h=m.offsetWidth,u=m.offsetHeight;if(h===0||u===0)return{clampedBgX:0,clampedBgY:0};const w=h*s,b=u*s,S=Math.max(d-w,Math.min(i,0)),T=Math.max(c-b,Math.min(e,0));f.style.backgroundPosition=`${S}px ${T}px`,g.style.transform=`translate(${S}px, ${T}px) scale(${s})`;const N=d/s*.5,p=c/s*.5,E=-S/s-N,y=-T/s-p,M=(-S+d)/s+N,C=(-T+c)/s+p;return l.forEach(x=>{const Y=a.stallIdToModalCloneMap.get(x.id);if(!Y||!x.numericCoords)return;const{left:X,top:U,width:F,height:I}=x.numericCoords,L=X/100*h,B=U/100*u,$=L+F/100*h,R=B+I/100*u,D=L<M&&$>E&&B<C&&R>y;Y.classList.toggle("modal-map-hidden",!D)}),P.forEach(x=>{const Y=a.rowIdToModalGroupCloneMap.get(x.id);if(!Y)return;const X=x.border.left/100*h,U=x.border.top/100*u,F=x.border.right/100*h,I=x.border.bottom/100*u,L=X<M&&F>E&&U<C&&I>y;Y.classList.toggle("modal-map-hidden",!L)}),ht(t,S,T,o),{clampedBgX:S,clampedBgY:T}}function ut(t,i){const{elements:e,isMobile:o}=i,{modalMagnifierWrapper:r,modalMagnifier:n,modalMagnifierStallLayer:l,mapImage:a}=e;if(!t||!t.coords){r.style.display="none";return}r.style.display="block",r.style.cursor="grab";const f=o?4.5:1.8,g=n.offsetWidth,m=n.offsetHeight;if(g===0||m===0){r.style.display="none";return}const s=a.offsetWidth,d=a.offsetHeight,c=s*f,h=d*f;l.style.width=`${s}px`,l.style.height=`${d}px`,n.style.backgroundSize=`${c}px ${h}px`,n.style.backgroundImage=`url('${a.src}')`;const{left:u,top:w,width:b,height:S}=t.numericCoords;if([u,w,b,S].some(M=>typeof M!="number")){console.error("Could not parse stall coordinates for modal magnifier:",t.coords),r.style.display="none";return}const T=(u+b/2)/100*s,N=(w+S/2)/100*d,p=g/2-T*f,E=m/2-N*f;nt(i,p,E,t);let y=l.querySelector(".modal-stall-highlight");y||(y=document.createElement("div"),y.className="modal-stall-highlight",l.appendChild(y)),y.style.width=t.coords.width,y.style.height=t.coords.height,y.style.left=t.coords.left,y.style.top=t.coords.top,y.style.visibility="visible"}function W(t,i){var S,T,N;const{allStalls:e,elements:o,magnifierController:r,uiState:n,isMobile:l}=i,a=e.find(p=>p.id===t);if(!a)return;r&&o.modal.classList.contains("hidden")&&(v.wasMagnifierVisible=r.isShown(),v.wasMagnifierVisible&&r.hide());const f=n.selectedStallElement,g=((S=f==null?void 0:f.dataset.stallId)==null?void 0:S.substring(0,1))??null;ot(o,r,n);const m=document.querySelector(`.stall-area[data-stall-id="${t}"]`);m&&(n.selectedStallElement=m,K(m,"is-selected",!0,r,n)),o.modalTitle.textContent=`${a.id}: ${a.stallTitle}`;let s=a.stallImg?`<img src="${a.stallImg}" alt="Official Promo Image: ${a.stallTitle}" class="official-stall-image" />`:"";a.stallImg&&a.promoData.length>0&&(s+='<hr class="promo-section-separator">'),a.promoData.forEach((p,E)=>{E>0&&(s+='<div class="promo-entry-separator"></div>');const y=p.promoAvatar?p.promoAvatar:"https://images.plurk.com/3rbw6tg1lA5dEGpdKTL8j1.png";s+=`
      <div class="promo-entry">
          <div class="modal-user-info">
              <img src="${y}" alt="${p.promoUser}" class="modal-avatar">
              <span class="modal-username">${p.promoUser}</span>
          </div>
          <div class="promo-html-content">${p.promoHTML}</div>
      </div>`}),o.modalBody.innerHTML=s||"暫無宣傳資訊。",o.modalFooter.innerHTML="";const d=p=>{if(p&&p.href){const E=document.createElement("a");E.href=p.href,E.textContent=p.text,E.className="footer-link",E.target="_blank",E.rel="noopener noreferrer",o.modalFooter.appendChild(E)}};a.promoData.forEach(p=>p.promoLinks.forEach(d)),a.stallLink&&d({href:a.stallLink,text:"社團網站"});const c=rt(e,o.searchInput.value),h=a.id.substring(0,1),w=["猴","雞","狗","特","商"].includes(h);if(w){o.modalNavLeft.style.display="none",o.modalNavRight.style.display="none",o.modalNavUp.style.display="block",o.modalNavDown.style.display="block",o.modalNavUp.ariaLabel="往上一個攤位",o.modalNavDown.ariaLabel="往下一個攤位";let p,E=1;for(;a.num+E<=34;){const C=(T=c.find(x=>x.id.startsWith(h)&&x.num===a.num+E))==null?void 0:T.id;if(C){p=C;break}E+=1}let y,M=-1;for(;a.num+M>0;){const C=(N=c.find(x=>x.id.startsWith(h)&&x.num===a.num+M))==null?void 0:N.id;if(C){y=C;break}M-=1}p||(p=_(a,c,"up")),y||(y=_(a,c,"down")),o.modalNavUp.disabled=!p,o.modalNavUp.dataset.targetId=p??"",o.modalNavDown.disabled=!y,o.modalNavDown.dataset.targetId=y??"",o.modalNavLeft.disabled=!0,o.modalNavRight.disabled=!0}else{o.modalNavLeft.style.display="block",o.modalNavRight.style.display="block",o.modalNavUp.style.display="block",o.modalNavDown.style.display="block",o.modalNavUp.ariaLabel="往上一排",o.modalNavDown.ariaLabel="往下一排";const p={up:_(a,c,"up"),down:_(a,c,"down"),left:_(a,c,"left"),right:_(a,c,"right")};o.modalNavUp.disabled=!p.up,o.modalNavUp.dataset.targetId=p.up??"",o.modalNavDown.disabled=!p.down,o.modalNavDown.dataset.targetId=p.down??"",o.modalNavLeft.disabled=!p.left,o.modalNavLeft.dataset.targetId=p.left??"",o.modalNavRight.disabled=!p.right,o.modalNavRight.dataset.targetId=p.right??""}const{modalVerticalStallList:b}=o;if(w){h!==g&&(b.scrollTop=0),b.innerHTML="",b.style.display="flex";const p=e.filter(M=>M.id.startsWith(h)).sort((M,C)=>C.num-M.num),E=o.searchInput.value.toLowerCase().trim();p.forEach(M=>{const C=document.createElement("div");C.className="modal-vertical-stall-item",C.dataset.stallId=M.id,C.textContent=M.num.toString().padStart(2,"0"),M.promoData.length>0&&C.classList.add("has-promo");let x=!1;if(E!==""){const Y=M.promoData.some(X=>X.promoUser.toLowerCase().includes(E));x=M.id.toLowerCase().includes(E)||M.stallTitle.toLowerCase().includes(E)||Y}x&&C.classList.add("is-search-match"),M.id===t&&C.classList.add("is-selected"),b.appendChild(C)});const y=b.querySelector(".is-selected");y&&requestAnimationFrame(()=>{y.scrollIntoView({behavior:"smooth",block:"center"})})}else b.innerHTML="",b.style.display="none";document.body.classList.add("body-modal-open"),o.modal.classList.remove("hidden"),o.modalNavControls.style.display="grid",o.modal.setAttribute("aria-hidden","true"),ut(a,i)}function j(t){const{elements:i,magnifierController:e,uiState:o}=t;document.body.classList.remove("body-modal-open"),i.modal.classList.add("hidden"),i.modalNavControls.style.display="none",i.modal.setAttribute("aria-hidden","true"),ot(i,e,o),e&&v.wasMagnifierVisible&&e.show(),v.wasMagnifierVisible=!1,i.modalMagnifierWrapper.style.display="none",i.modalVerticalStallList.style.display="none"}function pt(t,i){var a;const{allStalls:e,uiState:o}=i,r=t.closest(".stall-group-area"),n=t.closest(".stall-area:not(.stall-group-area)"),l=(a=o.selectedStallElement)==null?void 0:a.dataset.stallId;if(r!=null&&r.dataset.rowId){const f=r.dataset.rowId;if(f===(l==null?void 0:l.substring(0,1)))return;const g=e.filter(m=>m.id.startsWith(f)).sort((m,s)=>s.num-m.num);g.length>0&&W(g[0].id,i)}else if(n!=null&&n.dataset.stallId){const f=n.dataset.stallId;if(f===l)return;W(f,i)}}function gt(t){const{elements:i}=t;i.modalNavControls.addEventListener("click",s=>{const d=s.target.closest(".modal-nav-btn");d!=null&&d.dataset.targetId&&W(d.dataset.targetId,t)}),i.modalVerticalStallList.addEventListener("click",s=>{const d=s.target.closest(".modal-vertical-stall-item");d!=null&&d.dataset.stallId&&W(d.dataset.stallId,t)});const{modalMagnifierWrapper:e,modalMagnifier:o,modalMagnifierStallLayer:r}=i,n=()=>{v.isPanning&&(nt(t,v.targetBgX,v.targetBgY),v.animationFrameId=requestAnimationFrame(n))},l=s=>{var b;if(!v.isPanning)return;s.type==="touchmove"&&s.preventDefault();const d=(b=s.touches)==null?void 0:b[0],c=d?d.clientX:s.clientX,h=d?d.clientY:s.clientY,u=c-v.panStartX,w=h-v.panStartY;!v.panHappened&&(Math.abs(u)>5||Math.abs(w)>5)&&(v.panHappened=!0,e.style.cursor="grabbing"),v.panHappened&&(v.targetBgX=v.initialBgX+u,v.targetBgY=v.initialBgY+w)},a=()=>{cancelAnimationFrame(v.animationFrameId),document.removeEventListener("mousemove",l),document.removeEventListener("touchmove",l),document.removeEventListener("mouseup",a),document.removeEventListener("touchend",a),!v.panHappened&&v.clickTarget&&pt(v.clickTarget,t),v.isPanning=!1,v.clickTarget=null,e.style.cursor="grab",o.style.transition="",r.style.transition=""},f=s=>{var N,p;const d=s.target;if(d.closest("#modal-vertical-stall-list"))return;const c=d.closest(".stall-group-area"),h=(N=t.uiState.selectedStallElement)==null?void 0:N.dataset.stallId;if(c&&h){const E=c.dataset.rowId,y=h.substring(0,1);if(E===y)return}if("button"in s&&s.button!==0)return;v.isPanning=!0,v.panHappened=!1,v.clickTarget=s.target;const u=(p=s.touches)==null?void 0:p[0],w=u?u.clientX:s.clientX,b=u?u.clientY:s.clientY;v.panStartX=w,v.panStartY=b;const S=new DOMMatrix(window.getComputedStyle(r).transform);v.initialBgX=S.e,v.initialBgY=S.f,v.targetBgX=v.initialBgX,v.targetBgY=v.initialBgY,o.style.transition="none",r.style.transition="none";const T=r.querySelector(".modal-stall-highlight");T&&(T.style.visibility="hidden"),cancelAnimationFrame(v.animationFrameId),v.animationFrameId=requestAnimationFrame(n),document.addEventListener("mousemove",l),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("mouseup",a,{once:!0}),document.addEventListener("touchend",a,{once:!0})};e.addEventListener("mousedown",f),e.addEventListener("touchstart",f,{passive:!1}),i.modalClose.addEventListener("click",()=>j(t)),i.modalOverlay.addEventListener("click",()=>j(t)),document.addEventListener("keydown",s=>{if(!i.modal.classList.contains("hidden"))switch(s.key){case"Escape":j(t);break;case"ArrowUp":i.modalNavUp.click();break;case"ArrowDown":i.modalNavDown.click();break;case"ArrowLeft":i.modalNavLeft.click();break;case"ArrowRight":i.modalNavRight.click();break}});const{modalNavControls:g,tooltip:m}=i;g.addEventListener("mouseover",s=>{const d=s.target.closest(".modal-nav-btn");if(d instanceof HTMLButtonElement&&!d.disabled){const c=d.ariaLabel;if(c){m.innerHTML=c;const h=d.getBoundingClientRect();m.classList.remove("hidden");const u=m.getBoundingClientRect(),w=h.top-u.height-8,b=h.left+h.width/2-u.width/2;m.style.left=`${b}px`,m.style.top=`${w}px`}}else m.classList.add("hidden")}),g.addEventListener("mouseleave",()=>{m.classList.add("hidden")})}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function bt(t){const i=()=>ct.every(o=>document.getElementById(o)),e=()=>{i()?t():requestAnimationFrame(e)};e()}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function wt(t){P.forEach(i=>{const e=document.createElement("div");e.className="debug-border",e.style.top=`${i.border.top}%`,e.style.left=`${i.border.left}%`,e.style.width=`${i.border.right-i.border.left}%`,e.style.height=`${i.border.bottom-i.border.top}%`;const o=document.createElement("span");o.textContent=i.id,e.appendChild(o),t.appendChild(e)})}async function vt(){const t=mt();new URLSearchParams(window.location.search).get("debug")==="true"&&t.mapContainer.classList.add("debug-mode"),t.instructionsEl.textContent="正在載入地圖與攤位資料",t.instructionsEl.classList.add("loading-text");const e=new Promise((o,r)=>{t.mapImage.complete?o():(t.mapImage.onload=()=>o(),t.mapImage.onerror=()=>r(new Error("Map image failed to load.")))});try{const[o]=await Promise.all([it(),e]);if(t.instructionsEl.classList.remove("loading-text"),o.length===0){t.mapContainer.innerHTML='<p style="color: red; padding: 20px;"><b>無法載入攤位資料：</b><br>請檢查您的 Google Sheet 是否已「發佈至網路」、網址是否正確，或檢查您的網路連線。</p>',t.instructionsEl.textContent="載入失敗";return}const r=lt(o),l=window.matchMedia("(max-width: 768px)").matches,a={allStalls:r,elements:t,magnifierController:null,uiState:V,isMobile:l},f=s=>{const d=s.closest(".stall-group-area"),c=s.closest(".stall-area:not(.stall-group-area)");if(d!=null&&d.dataset.rowId){const h=d.dataset.rowId,u=r.filter(w=>w.id.startsWith(h)).sort((w,b)=>b.num-w.num);u.length>0&&W(u[0].id,a)}else c!=null&&c.dataset.stallId&&W(c.dataset.stallId,a)},g=dt(t.mapContainer,t.mapImage,t.magnifierWrapper,t.magnifier,t.magnifierStallLayer,{prev:t.magnifierRowIndicatorPrev,current:t.magnifierRowIndicatorCurrent,next:t.magnifierRowIndicatorNext},t.toggleMagnifierBtn,f,l);a.magnifierController=g,ft(r,t,g,V),wt(t.mapContainer),gt(a),t.searchInput.addEventListener("input",()=>{const s=t.searchInput.value.toLowerCase().trim(),d=new Set;r.forEach(c=>{const h=document.querySelector(`.stall-area[data-stall-id="${c.id}"]`);if(!h)return;let u=!1;if(s!==""){const w=c.promoData.some(b=>b.promoUser.toLowerCase().includes(s));u=c.id.toLowerCase().includes(s)||c.stallTitle.toLowerCase().includes(s)||w}K(h,"is-search-match",u,g,V),u&&d.add(c.id.substring(0,1))}),P.forEach(c=>{document.querySelectorAll(`.stall-group-area[data-row-id="${c.id}"]`).forEach(u=>{const w=d.has(c.id);u.classList.toggle("is-search-match",w)})})});const m=s=>{const d=s.target;d.closest("#magnifier-wrapper")||(s.type==="touchstart"&&s.preventDefault(),f(d))};l?(t.instructionsEl.textContent="點擊按鈕可用放大鏡，或直接點擊攤位查看宣傳。",t.mapContainer.addEventListener("mousedown",m,{passive:!1}),t.mapContainer.addEventListener("touchstart",m,{passive:!1})):(t.instructionsEl.textContent="點擊按鈕顯示/隱藏放大鏡並拖曳。點擊攤位(含放大鏡內)可看宣傳。",document.addEventListener("mousemove",s=>{V.selectedStallElement||(t.tooltip.style.left=`${s.clientX+15}px`,t.tooltip.style.top=`${s.clientY+15}px`)}),t.mapContainer.addEventListener("mouseover",s=>{var h;const c=s.target.closest(".stall-area:not(.stall-group-area)");if(c&&!V.selectedStallElement){const u=c.dataset.stallId,w=r.find(b=>b.id===u);if(w){const b=(h=w.promoData)==null?void 0:h[0];t.tooltip.innerHTML=`<strong>${w.stallTitle}</strong><br><small>${w.id}${b!=null&&b.promoUser?` / ${b.promoUser}`:""}</small>`,t.tooltip.classList.remove("hidden")}}}),t.mapContainer.addEventListener("mouseout",s=>{s.target.classList.contains("stall-area")&&t.tooltip.classList.add("hidden")}),t.mapContainer.addEventListener("mousedown",m))}catch(o){console.error("Failed to initialize app:",o),t.instructionsEl.classList.remove("loading-text"),t.instructionsEl.textContent="地圖或資料載入失敗，請重新整理頁面。"}}bt(vt);
